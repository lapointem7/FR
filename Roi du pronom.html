<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Test des Rois de la Grammaire du Pronom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;500;700&display=swap');


        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0fdf4; /* Light green tint */
        }


        .handwritten {
            font-family: 'Patrick Hand', cursive;
        }


        .word-span {
            cursor: pointer;
            padding: 6px 8px; /* Slightly larger padding */
            border-radius: 6px;
            transition: all 0.2s;
            position: relative;
            display: inline-block;
            margin: 0 2px;
            border: 1px solid transparent;
        }


        .word-span:hover {
            background-color: #e5e7eb;
            transform: scale(1.05);
            border-color: #d1d5db;
        }


        /* Found state for identification */
        .word-span.found-pronoun {
            background-color: #dcfce7;
            color: #166534;
            border-color: #22c55e;
            font-weight: bold;
            pointer-events: none; /* Prevent re-clicking */
        }


        /* Tooltip (Phylactère) Styles */
        .tooltip {
            position: absolute;
            bottom: 140%; /* Higher due to larger text */
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 14px;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            white-space: nowrap;
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            font-weight: bold;
        }


        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
        }


        .tooltip.show {
            opacity: 1;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }


        .tooltip.is-pronoun {
            background-color: #16a34a; /* Green-600 */
        }
        .tooltip.is-pronoun::after {
            border-color: #16a34a transparent transparent transparent;
        }


        .tooltip.not-pronoun {
            background-color: #ef4444; /* Red-500 */
        }
        .tooltip.not-pronoun::after {
            border-color: #ef4444 transparent transparent transparent;
        }


        /* Antecedent Exercise Styles */
        .antecedent-word {
            cursor: pointer;
            border-bottom: 2px dashed #9ca3af;
        }
        .antecedent-word:hover {
            background-color: #dbeafe;
        }
        .antecedent-word.correct {
            background-color: #86efac;
            border-color: #166534;
            color: #14532d;
        }
        .antecedent-word.wrong {
            background-color: #fca5a5;
            text-decoration: line-through;
        }


        @keyframes popIn {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }


        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .score-badge {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .score-bump {
            transform: scale(1.3);
            color: #fbbf24;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 md:p-4">


    <!-- Container -->
    <div class="bg-white w-full max-w-6xl rounded-2xl shadow-2xl overflow-hidden min-h-[700px] flex flex-col relative border border-gray-100">
        
        <!-- Header -->
        <header class="bg-slate-800 text-white p-4 md:p-6 flex flex-col md:flex-row justify-between items-center shadow-md z-10 gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="bg-yellow-400 text-slate-900 p-2 rounded-full w-14 h-14 flex items-center justify-center font-bold text-3xl shadow-lg border-2 border-yellow-200">
                    <i class="fas fa-crown"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold handwritten tracking-wide text-yellow-400">Rois de la Grammaire</h1>
                    <p class="text-slate-300 text-sm md:text-base">Test Ultime du Pronom</p>
                </div>
            </div>


            <div class="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end">
                <!-- Progress -->
                <div class="bg-slate-700 px-5 py-3 rounded-lg text-base font-semibold border border-slate-600">
                    <i class="fas fa-layer-group mr-2 text-indigo-400"></i>
                    <span id="progress-text">1 / 15</span>
                </div>
                
                <!-- Score -->
                <div class="bg-slate-900 px-6 py-3 rounded-lg text-xl font-bold border border-yellow-500/30 flex items-center gap-2 shadow-inner">
                    <i class="fas fa-star text-yellow-400"></i>
                    <span id="score-display" class="score-badge text-white">0</span>
                    <span class="text-slate-500 text-base font-normal">/ <span id="max-score">0</span></span>
                </div>
            </div>
        </header>


        <!-- Content Area -->
        <main id="app-content" class="flex-grow p-4 md:p-10 flex flex-col justify-center items-center relative bg-gray-50">
            <!-- Dynamic Content will be injected here via JS -->
        </main>


        <!-- Footer / Controls -->
        <footer class="bg-white p-4 md:p-8 border-t border-gray-100 flex justify-between items-center">
            <button id="btn-prev" class="px-8 py-3 rounded-lg text-lg text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition disabled:opacity-30 disabled:cursor-not-allowed hidden font-medium">
                <i class="fas fa-arrow-left mr-2"></i> Précédent
            </button>
            
            <div class="hidden md:flex gap-2" id="dots-container">
                <!-- Dots generated by JS -->
            </div>


            <button id="btn-next" class="bg-indigo-600 hover:bg-indigo-700 text-white px-10 py-4 rounded-lg shadow-lg transform transition active:scale-95 flex items-center font-bold tracking-wide text-lg">
                Suivant <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </footer>
    </div>


    <!-- JavaScript Application Logic -->
    <script>
        // --- DATA ---
        let slides = [
            // Slide 0: Intro
            {
                type: 'intro',
                title: "Le Défi Royal",
                content: `
                    <div class="text-center space-y-8 max-w-2xl mx-auto">
                        <div class="text-8xl text-yellow-500 mb-6 drop-shadow-md animate-[bounce_2s_infinite]">
                            <i class="fas fa-chess-king"></i>
                        </div>
                        <p class="text-2xl text-gray-700 font-medium">
                            Bienvenue, futur expert !
                        </p>
                        <p class="text-xl text-gray-600">
                            Ce test est noté. Tu dois accumuler des points pour prouver que tu maîtrises les pronoms à la perfection.
                        </p>
                        <div class="grid grid-cols-3 gap-6 mt-8">
                            <div class="bg-green-100 p-4 rounded-xl text-green-800 text-base font-bold">
                                <i class="fas fa-search block text-3xl mb-2"></i> Identifier
                            </div>
                            <div class="bg-blue-100 p-4 rounded-xl text-blue-800 text-base font-bold">
                                <i class="fas fa-link block text-3xl mb-2"></i> Relier
                            </div>
                            <div class="bg-purple-100 p-4 rounded-xl text-purple-800 text-base font-bold">
                                <i class="fas fa-pen block text-3xl mb-2"></i> Remplacer
                            </div>
                        </div>
                    </div>
                `
            },
            // --- IDENTIFICATION (Plus difficile) ---
            {
                type: 'info',
                title: "Niveau 1 : Le Radar",
                content: "<p class='text-center text-xl'>Clique sur <strong>TOUS</strong> les pronoms.<br>Chaque pronom trouvé = 1 point.</p>"
            },
            {
                type: 'identification',
                // Confusion LE/LA det vs pronom
                sentence: [
                    {text: "Je", class: "Pronom", type: "Pronom personnel"},
                    {text: "le", class: "Pronom", type: "Pronom personnel (CD)"},
                    {text: "regarde", class: "Verbe"},
                    {text: ",", class: "Ponctuation"},
                    {text: "mais", class: "Conjonction"},
                    {text: "le", class: "Déterminant"},
                    {text: "chien", class: "Nom"},
                    {text: "ne", class: "Adverbe"},
                    {text: "me", class: "Pronom", type: "Pronom personnel"},
                    {text: "voit", class: "Verbe"},
                    {text: "pas", class: "Adverbe"},
                    {text: ".", class: "Ponctuation"}
                ]
            },
            {
                type: 'identification',
                // Possessifs et Démonstratifs - FIX LA MIENNE
                sentence: [
                    {text: "Ta", class: "Déterminant"},
                    {text: "maison", class: "Nom"},
                    {text: "est", class: "Verbe"},
                    {text: "belle", class: "Adjectif"},
                    {text: ",", class: "Ponctuation"},
                    {text: "mais", class: "Conjonction"},
                    {text: "la mienne", class: "Pronom", type: "Pronom possessif"},
                    {text: "est", class: "Verbe"},
                    {text: "plus", class: "Adverbe"},
                    {text: "grande", class: "Adjectif"},
                    {text: "que", class: "Conjonction"},
                    {text: "celle", class: "Pronom", type: "Pronom démonstratif"},
                    {text: "de", class: "Préposition"},
                    {text: "Paul", class: "Nom"},
                    {text: ".", class: "Ponctuation"}
                ]
            },
            {
                type: 'identification',
                // Indéfinis et Relatifs
                sentence: [
                    {text: "Quiconque", class: "Pronom", type: "Pronom relatif indéfini"},
                    {text: "réussira", class: "Verbe"},
                    {text: "ce", class: "Déterminant"},
                    {text: "test", class: "Nom"},
                    {text: "recevra", class: "Verbe"},
                    {text: "tout", class: "Pronom", type: "Pronom indéfini"},
                    {text: "ce", class: "Pronom", type: "Pronom démonstratif"},
                    {text: "qu'", class: "Pronom", type: "Pronom relatif"},
                    {text: "il", class: "Pronom", type: "Pronom personnel"},
                    {text: "désire", class: "Verbe"},
                    {text: ".", class: "Ponctuation"}
                ]
            },
            {
                type: 'identification',
                // Négation et En
                sentence: [
                    {text: "Personne", class: "Pronom", type: "Pronom indéfini"},
                    {text: "n'", class: "Adverbe"},
                    {text: "en", class: "Pronom", type: "Pronom personnel"},
                    {text: "veut", class: "Verbe"},
                    {text: ",", class: "Ponctuation"},
                    {text: "même", class: "Adverbe"},
                    {text: "s'", class: "Conjonction"},
                    {text: "ils", class: "Pronom", type: "Pronom personnel"},
                    {text: "savent", class: "Verbe"},
                    {text: "que", class: "Conjonction"},
                    {text: "c'", class: "Pronom", type: "Pronom démonstratif"},
                    {text: "est", class: "Verbe"},
                    {text: "gratuit", class: "Adjectif"},
                    {text: ".", class: "Ponctuation"}
                ]
            },


            // --- ANTÉCÉDENT (Logique) ---
            {
                type: 'info',
                title: "Niveau 2 : Le Détective",
                content: "<p class='text-center text-xl'>Trouve le mot remplacé par le pronom en gras.<br>Attention aux pièges d'accord !</p>"
            },
            {
                type: 'antecedent',
                context: "Les enfants de ma soeur sont très bruyants.",
                targetSentence: "Pourtant, <strong>elle</strong> est très calme.",
                words: [
                    {text: "Les", correct: false},
                    {text: "enfants", correct: false, feedback: "Non, 'enfants' est pluriel. 'Elle' est singulier."},
                    {text: "de", correct: false},
                    {text: "ma", correct: false},
                    {text: "soeur", correct: true, feedback: "Bravo ! 'Elle' remplace 'ma soeur'."},
                    {text: "sont", correct: false},
                    {text: "très", correct: false},
                    {text: "bruyants", correct: false}
                ],
                pronoun: "elle"
            },
            {
                type: 'antecedent',
                // Distracteur pluriel
                context: "J'ai acheté trois livres et une revue hier.",
                targetSentence: "Je <strong>les</strong> ai déjà tous lus.",
                words: [
                    {text: "J'", correct: false},
                    {text: "ai", correct: false},
                    {text: "acheté", correct: false},
                    {text: "trois", correct: false},
                    {text: "livres", correct: true, feedback: "Correct ! 'Tous lus' (masculin pluriel) indique qu'on parle des livres (et de la revue, mais 'livres' domine)."},
                    {text: "et", correct: false},
                    {text: "une", correct: false},
                    {text: "revue", correct: true, feedback: "Accepté ! 'Les' englobe les livres et la revue."},
                    {text: "hier", correct: false}
                ],
                pronoun: "les"
            },
            {
                type: 'antecedent',
                // Confusion objet/personne
                context: "Le directeur a donné son avis aux employés.",
                targetSentence: "<strong>Il</strong> était très favorable.",
                words: [
                    {text: "Le", correct: false},
                    {text: "directeur", correct: false, feedback: "Le directeur est favorable ? Peut-être, mais grammaticalement 'Il' (favorable) réfère ici à l'avis."},
                    {text: "a", correct: false},
                    {text: "donné", correct: false},
                    {text: "son", correct: false},
                    {text: "avis", correct: true, feedback: "Exact ! C'est l'avis qui est favorable."},
                    {text: "aux", correct: false},
                    {text: "employés", correct: false, feedback: "'Employés' est pluriel."}
                ],
                pronoun: "Il"
            },
            {
                type: 'antecedent',
                // Groupe nominal complexe
                context: "La vieille voiture de mon père ne démarre plus.",
                targetSentence: "<strong>Elle</strong> est bonne pour la ferraille.",
                words: [
                    {text: "La", correct: false},
                    {text: "vieille", correct: false},
                    {text: "voiture", correct: true, feedback: "Oui, c'est la voiture qui est bonne pour la ferraille."},
                    {text: "de", correct: false},
                    {text: "mon", correct: false},
                    {text: "père", correct: false, feedback: "On ne met pas papa à la ferraille ! 'Elle' est féminin, 'père' est masculin."}
                ],
                pronoun: "Elle"
            },


            // --- SUBSTITUTION (Expert) ---
            {
                type: 'info',
                title: "Niveau 3 : Le Constructeur",
                content: "<p class='text-center text-xl'>Choisis le pronom exact pour remplacer les mots en gras.<br>Attention : 'lui' vs 'y' vs 'en'.</p>"
            },
            {
                type: 'substitution',
                sentence1: "Je parle <strong>à mes parents</strong>.",
                sentence2Part1: "Je ",
                sentence2Part2: " parle.",
                options: ["les", "leur", "eux", "y"],
                correct: "leur",
                feedback: "Parfait ! Parler À plusieurs personnes -> leur."
            },
            {
                type: 'substitution',
                sentence1: "Il revient <strong>de l'école</strong>.",
                sentence2Part1: "Il ",
                sentence2Part2: " revient.",
                options: ["y", "la", "en", "de"],
                correct: "en",
                feedback: "Excellent ! Revenir DE quelque part -> en."
            },
            {
                type: 'substitution',
                sentence1: "Nous pensons <strong>à notre projet</strong>.",
                sentence2Part1: "Nous ",
                sentence2Part2: " pensons.",
                options: ["lui", "y", "le", "en"],
                correct: "y",
                feedback: "Bravo ! Penser À une chose (inanimé) -> y. (Si c'était une personne, ce serait 'à lui/elle')."
            },
            {
                type: 'substitution',
                // Double difficulté
                sentence1: "Julie raconte l'histoire <strong>à son frère</strong>.",
                sentence2Part1: "Julie ",
                sentence2Part2: " raconte l'histoire.",
                options: ["le", "se", "lui", "y"],
                correct: "lui",
                feedback: "Exact ! Raconter À quelqu'un -> lui."
            },
            {
                type: 'substitution',
                // Pronom possessif vs personnel
                sentence1: "J'ai perdu mon crayon. Je vais prendre <strong>celui de Paul</strong>.",
                sentence2Part1: "Je vais prendre ",
                sentence2Part2: ".",
                options: ["le", "le sien", "lui", "celui-ci"],
                correct: "le sien",
                feedback: "Superbe ! Pour remplacer 'le crayon de Paul' (possession), on utilise le pronom possessif 'le sien'."
            },


            // Fin
            {
                type: 'intro',
                title: "Résultat Final",
                content: `
                    <div class="text-center space-y-6">
                        <div id="final-score-icon" class="text-7xl text-gray-300 mb-4">
                            <i class="fas fa-medal"></i>
                        </div>
                        <h2 class="text-4xl font-bold text-gray-800">Test terminé !</h2>
                        <div class="bg-white border-2 border-dashed border-indigo-200 p-8 rounded-xl inline-block shadow-sm">
                            <p class="text-gray-500 uppercase text-sm font-bold tracking-wider mb-2">Ton Score</p>
                            <p class="text-6xl font-black text-indigo-600" id="final-score-value">0/0</p>
                        </div>
                        <p id="final-message" class="text-2xl text-gray-700 font-medium mt-4">
                            <!-- Message JS -->
                        </p>
                        <div class="mt-8">
                            <button onclick="location.reload()" class="bg-slate-800 text-white px-10 py-4 rounded-lg font-bold hover:bg-slate-700 transition shadow-lg text-lg">
                                <i class="fas fa-redo mr-2"></i> Recommencer le test
                            </button>
                        </div>
                    </div>
                `
            }
        ];


        let appState = {
            currentSlide: 0,
            score: 0,
            maxScore: 0
        };


        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('app-content');
        const btnNext = document.getElementById('btn-next');
        const btnPrev = document.getElementById('btn-prev');
        const dotsContainer = document.getElementById('dots-container');
        const progressText = document.getElementById('progress-text');
        const scoreDisplay = document.getElementById('score-display');
        const maxScoreDisplay = document.getElementById('max-score');


        // --- INITIALIZATION ---
        function initGame() {
            let totalPoints = 0;
            
            // Calculate Max Score
            slides.forEach(slide => {
                if (slide.type === 'identification') {
                    // Points = number of pronouns
                    slide.sentence.forEach(w => {
                        if (w.class === 'Pronom') totalPoints++;
                    });
                } else if (slide.type === 'antecedent') {
                    // 1 point per slide
                    totalPoints++;
                    slide.answered = false; // Reset state
                } else if (slide.type === 'substitution') {
                    // 1 point per slide
                    totalPoints++;
                    slide.answered = false; // Reset state
                }
            });


            appState.maxScore = totalPoints;
            maxScoreDisplay.innerText = totalPoints;
            renderSlide();
        }


        // --- CORE LOGIC ---


        function addScore(points) {
            appState.score += points;
            scoreDisplay.innerText = appState.score;
            
            // Animation bump
            scoreDisplay.classList.add('score-bump');
            setTimeout(() => scoreDisplay.classList.remove('score-bump'), 300);
        }


        function renderSlide() {
            const slide = slides[appState.currentSlide];
            
            // Update UI State
            updateDots();
            progressText.innerText = `${appState.currentSlide + 1} / ${slides.length}`;
            
            // Clear content with fade effect
            mainContent.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'w-full fade-in flex flex-col items-center';
            
            // Logic based on slide type
            if (slide.type === 'intro' || slide.type === 'info') {
                renderInfoSlide(slide, container);
            } else if (slide.type === 'identification') {
                renderIdentificationSlide(slide, container);
            } else if (slide.type === 'antecedent') {
                renderAntecedentSlide(slide, container);
            } else if (slide.type === 'substitution') {
                renderSubstitutionSlide(slide, container);
            }


            mainContent.appendChild(container);


            // Button Logic
            btnPrev.style.display = appState.currentSlide === 0 ? 'none' : 'block';
            
            // Handle End of Game Screen
            if (appState.currentSlide === slides.length - 1) {
                btnNext.style.display = 'none';
                updateFinalScreen();
            } else {
                btnNext.style.display = 'flex';
            }
        }


        function updateFinalScreen() {
            const ratio = appState.score / appState.maxScore;
            const finalValue = document.getElementById('final-score-value');
            const finalMsg = document.getElementById('final-message');
            const icon = document.getElementById('final-score-icon');


            if (finalValue) finalValue.innerText = `${appState.score}/${appState.maxScore}`;
            
            if (finalMsg) {
                if (ratio >= 0.9) {
                    finalMsg.innerHTML = "Incroyable ! Tu es le <span class='text-yellow-500 font-bold'>Roi du Pronom</span> !";
                    icon.innerHTML = "<i class='fas fa-crown text-yellow-400'></i>";
                    icon.classList.add('animate-bounce');
                } else if (ratio >= 0.7) {
                    finalMsg.innerText = "Très bon travail ! Tu maîtrises bien la matière.";
                    icon.innerHTML = "<i class='fas fa-thumbs-up text-blue-500'></i>";
                } else {
                    finalMsg.innerText = "Continue tes efforts, tu y es presque !";
                    icon.innerHTML = "<i class='fas fa-book-reader text-indigo-400'></i>";
                }
            }
        }


        function renderInfoSlide(slide, container) {
            container.innerHTML = `
                <h2 class="text-4xl md:text-5xl font-bold text-slate-800 text-center mb-8 handwritten mt-4">${slide.title || ''}</h2>
                <div class="bg-white p-8 md:p-10 rounded-xl shadow-lg border border-gray-100 max-w-3xl w-full">
                    ${slide.content}
                </div>
            `;
        }


        function renderIdentificationSlide(slide, container) {
            const wrapper = document.createElement('div');
            wrapper.className = "flex flex-col items-center justify-center space-y-6 mt-4 w-full max-w-5xl";


            // Count pronouns
            const totalPronouns = slide.sentence.filter(w => w.class === 'Pronom').length;
            const foundCount = slide.sentence.filter(w => w.class === 'Pronom' && w.isFound).length;
            const allFound = foundCount === totalPronouns;


            const instruction = document.createElement('div');
            const bgClass = allFound ? "bg-green-100 text-green-800 border-green-200" : "bg-indigo-50 text-indigo-800 border-indigo-200";
            instruction.className = `${bgClass} border px-6 py-3 rounded-full text-lg font-bold flex items-center gap-3 mb-2 transition-colors duration-300`;
            
            // Dynamic Instruction Text
            if (allFound) {
                instruction.innerHTML = `<i class='fas fa-check-circle'></i> Terminé ! (${foundCount}/${totalPronouns})`;
            } else {
                instruction.innerHTML = `<i class='fas fa-search'></i> Trouve les pronoms : ${foundCount} / ${totalPronouns}`;
            }
            
            wrapper.appendChild(instruction);


            const sentenceDiv = document.createElement('div');
            sentenceDiv.className = "text-2xl md:text-3xl leading-loose font-medium text-slate-700 bg-white p-8 md:p-12 rounded-xl border-2 border-slate-100 shadow-md w-full text-left md:text-center";


            slide.sentence.forEach((wordObj, index) => {
                const span = document.createElement('span');
                span.textContent = wordObj.text;
                span.className = "word-span relative select-none";
                
                // Check if already found in state
                if (wordObj.isFound) {
                    span.classList.add('found-pronoun');
                }
                
                // Interaction Logic
                span.onclick = (e) => {
                    if (wordObj.isFound) return; // Already found


                    // Remove existing tooltips
                    document.querySelectorAll('.tooltip').forEach(t => t.remove());


                    const tooltip = document.createElement('div');
                    const isPronoun = wordObj.class === "Pronom";
                    
                    tooltip.className = `tooltip ${isPronoun ? 'is-pronoun' : 'not-pronoun'}`;
                    
                    if (isPronoun) {
                        tooltip.innerHTML = `<i class="fas fa-check mr-1"></i> <strong>${wordObj.type}</strong>`;
                        wordObj.isFound = true; // Mark as found
                        span.classList.add('found-pronoun');
                        addScore(1); // Point!
                        
                        // Update counter
                        const newFoundCount = slide.sentence.filter(w => w.class === 'Pronom' && w.isFound).length;
                        if (newFoundCount === totalPronouns) {
                            instruction.className = "bg-green-100 text-green-800 border border-green-200 px-6 py-3 rounded-full text-lg font-bold flex items-center gap-3 mb-2 transition-colors duration-300";
                            instruction.innerHTML = `<i class='fas fa-check-circle'></i> Terminé ! (${newFoundCount}/${totalPronouns})`;
                        } else {
                            instruction.innerHTML = `<i class='fas fa-search'></i> Trouve les pronoms : ${newFoundCount} / ${totalPronouns}`;
                        }


                    } else {
                        tooltip.innerHTML = `<i class="fas fa-times mr-1"></i> ${wordObj.class}`;
                    }


                    span.appendChild(tooltip);
                    void tooltip.offsetWidth;
                    tooltip.classList.add('show');
                };


                sentenceDiv.appendChild(span);
                
                // Space logic
                if (index < slide.sentence.length - 1) {
                    const currentTxt = wordObj.text;
                    const nextTxt = slide.sentence[index+1].text;
                    // Simple logic to avoid spacing before dots/commas, 
                    // AND ensuring "la mienne" (if it were split) is handled, but here it's one token.
                    if (!currentTxt.endsWith("'") && !['.', ',', ')'].includes(nextTxt)) {
                        sentenceDiv.appendChild(document.createTextNode(" "));
                    }
                }
            });


            wrapper.appendChild(sentenceDiv);
            container.appendChild(wrapper);
        }


        function renderAntecedentSlide(slide, container) {
            const wrapper = document.createElement('div');
            wrapper.className = "max-w-4xl w-full mt-6 space-y-8";


            const instruction = document.createElement('div');
            instruction.className = "bg-blue-50 text-blue-800 p-5 rounded-lg flex items-center justify-center gap-3 text-lg md:text-xl shadow-sm border border-blue-100 font-medium";
            instruction.innerHTML = `
                <i class="fas fa-search"></i>
                <p><strong>${slide.pronoun}</strong> remplace quel mot ?</p>
            `;
            wrapper.appendChild(instruction);


            // Sentence Container
            const sentenceBox = document.createElement('div');
            sentenceBox.className = "bg-white p-8 md:p-12 rounded-xl shadow-lg border border-gray-100 text-2xl md:text-3xl relative overflow-hidden";
            
            // Already answered visualization
            if (slide.answered) {
                 sentenceBox.classList.add('border-l-8', slide.wasCorrect ? 'border-green-400' : 'border-red-400');
            }


            // Sentence 1 (Clickable)
            const sent1Div = document.createElement('div');
            sent1Div.className = "mb-8 leading-loose border-b border-gray-100 pb-6";
            
            slide.words.forEach((w) => {
                const span = document.createElement('span');
                span.textContent = w.text;
                span.className = "word-span antecedent-word rounded px-2 mx-0.5";
                
                // Disable if already answered
                if (slide.answered) span.style.pointerEvents = "none";


                span.onclick = function() {
                    if (slide.answered) return;


                    // Logic
                    slide.answered = true;
                    slide.wasCorrect = w.correct;


                    // Remove existing feedback
                    const existingFeedback = document.getElementById('feedback-box');
                    if(existingFeedback) existingFeedback.remove();


                    // Create Feedback
                    const feedbackBox = document.createElement('div');
                    feedbackBox.id = "feedback-box";
                    feedbackBox.className = "mt-6 p-5 rounded-lg text-lg font-bold flex items-center gap-3 animate-fade-in";


                    if (w.correct) {
                        span.classList.add('correct');
                        addScore(1);
                        feedbackBox.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
                        feedbackBox.innerHTML = `<i class="fas fa-check-circle text-3xl"></i> <div>${w.feedback}</div>`;
                    } else {
                        span.classList.add('wrong');
                        feedbackBox.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
                        feedbackBox.innerHTML = `<i class="fas fa-times-circle text-3xl"></i> <div>${w.feedback || "Erreur d'accord ou de sens."}</div>`;
                    }
                    
                    sentenceBox.appendChild(feedbackBox);
                };
                
                sent1Div.appendChild(span);
                sent1Div.appendChild(document.createTextNode(" "));
            });


            // Sentence 2
            const sent2Div = document.createElement('div');
            sent2Div.className = "text-slate-600 bg-gray-50 p-6 rounded-lg font-medium";
            sent2Div.innerHTML = slide.targetSentence;


            sentenceBox.appendChild(sent1Div);
            sentenceBox.appendChild(sent2Div);
            wrapper.appendChild(sentenceBox);
            container.appendChild(wrapper);
        }


        function renderSubstitutionSlide(slide, container) {
            const wrapper = document.createElement('div');
            wrapper.className = "max-w-3xl w-full mt-8 space-y-8";


            const card = document.createElement('div');
            card.className = "bg-white p-8 md:p-12 rounded-xl shadow-lg border border-gray-100";
            
            if (slide.answered) {
                 card.classList.add('border-l-8', slide.wasCorrect ? 'border-green-400' : 'border-red-400');
            }


            // Original
            const original = document.createElement('div');
            original.className = "bg-purple-50 p-6 rounded-lg text-2xl text-purple-900 mb-8 font-medium";
            original.innerHTML = slide.sentence1;
            card.appendChild(original);


            // Interaction
            const interactionLine = document.createElement('div');
            interactionLine.className = "text-3xl text-slate-800 flex flex-wrap items-center gap-4 leading-loose";
            
            const part1 = document.createElement('span');
            part1.textContent = slide.sentence2Part1;
            
            const select = document.createElement('select');
            select.className = "bg-white border-2 border-indigo-200 rounded px-4 py-2 text-indigo-700 font-bold focus:outline-none focus:border-indigo-500 cursor-pointer text-2xl shadow-sm transition hover:border-indigo-400";
            
            if (slide.answered) select.disabled = true;


            const defOpt = document.createElement('option');
            defOpt.text = "...";
            defOpt.value = "";
            select.add(defOpt);


            slide.options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt;
                o.text = opt;
                select.add(o);
            });


            const part2 = document.createElement('span');
            part2.textContent = slide.sentence2Part2;


            interactionLine.appendChild(part1);
            interactionLine.appendChild(select);
            interactionLine.appendChild(part2);
            card.appendChild(interactionLine);


            const feedbackDiv = document.createElement('div');
            feedbackDiv.id = "sub-feedback";
            card.appendChild(feedbackDiv);


            select.addEventListener('change', (e) => {
                const val = e.target.value;
                if (!val || slide.answered) return;


                slide.answered = true;
                
                feedbackDiv.classList.remove('hidden');
                
                if (val === slide.correct) {
                    addScore(1);
                    slide.wasCorrect = true;
                    select.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                    select.classList.remove('border-indigo-200');
                    feedbackDiv.className = "mt-8 p-6 rounded bg-green-100 text-green-800 flex items-center gap-4 animate-pulse border border-green-200 font-bold text-xl";
                    feedbackDiv.innerHTML = `<i class="fas fa-check text-2xl"></i> ${slide.feedback}`;
                } else {
                    slide.wasCorrect = false;
                    select.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                    select.classList.remove('border-indigo-200');
                    feedbackDiv.className = "mt-8 p-6 rounded bg-red-100 text-red-800 flex items-center gap-4 border border-red-200 font-bold text-xl";
                    feedbackDiv.innerHTML = `<i class="fas fa-times text-2xl"></i> Non. La bonne réponse était : "${slide.correct}".`;
                }
            });


            wrapper.appendChild(card);
            container.appendChild(wrapper);
        }


        function updateDots() {
            dotsContainer.innerHTML = '';
            slides.forEach((_, idx) => {
                const dot = document.createElement('div');
                let colorClass = 'bg-gray-300';
                if (idx === appState.currentSlide) colorClass = 'bg-indigo-600 w-6';
                else if (idx < appState.currentSlide) colorClass = 'bg-indigo-200'; // Passed slides
                
                dot.className = `w-2 h-2 rounded-full transition-all duration-300 ${colorClass}`;
                dotsContainer.appendChild(dot);
            });
        }


        // --- EVENTS ---
        btnNext.addEventListener('click', () => {
            if (appState.currentSlide < slides.length - 1) {
                appState.currentSlide++;
                renderSlide();
            }
        });


        btnPrev.addEventListener('click', () => {
            if (appState.currentSlide > 0) {
                appState.currentSlide--;
                renderSlide();
            }
        });


        // --- INIT ---
        initGame();


    </script>
</body>
</html>