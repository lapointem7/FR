import * as React from 'react';
import { BookOpen, CircleHelp, Search, CircleCheck, ArrowRight, ArrowLeft, RotateCcw, PenTool, CircleAlert, Sparkles, X, MessageCircle, Eye, ListFilter, Scissors, Type } from 'lucide-react';


const { useState, useEffect } = React;


// --- COMPOSANT VISUALISATEUR UNIVERSEL ---
const StepVisualizer = ({ type, data }) => {
    if (!data) return null;


    // Visualisation : Contexte (Le Détective)
    if (type === 'context') {
        return (
            <div className="bg-indigo-50 p-6 rounded-xl border-2 border-indigo-100 mb-6 flex flex-col items-center animate-in fade-in slide-in-from-bottom-4 duration-700">
                <h4 className="text-indigo-800 font-bold uppercase tracking-wider text-sm mb-4 flex items-center gap-2">
                    <Eye size={18}/> Analyse du Détective
                </h4>
                <div className="flex flex-wrap gap-4 items-end justify-center">
                    {data.words.map((item, i) => (
                        <div key={i} className="flex flex-col items-center relative group">
                            {item.label && (
                                <div className={`absolute -top-10 md:-top-8 text-xs font-bold uppercase whitespace-nowrap px-2 py-1 rounded shadow-sm ${item.labelColor || 'bg-slate-200 text-slate-700'}`}>
                                    {item.label}
                                    <div className={`absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[4px] ${item.arrowColor || 'border-t-slate-200'}`}></div>
                                </div>
                            )}
                            <span className={`text-xl md:text-3xl font-hand px-3 py-2 rounded-lg transition-all ${item.highlight || 'text-slate-600'} ${item.border || ''}`}>
                                {item.text}
                            </span>
                            {item.relation && <div className="absolute -bottom-2 w-full h-1 bg-indigo-200 rounded-full"></div>}
                        </div>
                    ))}
                </div>
                {data.description && <p className="mt-6 md:mt-4 text-indigo-700 text-sm italic text-center max-w-lg">{data.description}</p>}
            </div>
        );
    }


    // Visualisation : Manipulation Syntaxique
    if (type === 'manipulation') {
        return (
            <div className="bg-emerald-50 p-3 rounded-xl border-2 border-emerald-100 mb-2 flex flex-col items-center animate-in fade-in slide-in-from-bottom-4 duration-700 w-full max-w-2xl mx-auto">
                <h4 className="text-emerald-800 font-bold uppercase tracking-wider text-xs mb-2 flex items-center gap-2">
                    <Scissors size={14}/> Test de Manipulation
                </h4>
                <div className="flex flex-row items-center justify-center gap-4 w-full">
                    {/* Partie gauche : Mot à tester */}
                    <div className="text-sm text-slate-500 whitespace-nowrap">
                        Mot à tester : <span className="font-hand text-slate-900 font-bold text-lg ml-1">{data.word}</span>
                    </div>
                    
                    <ArrowRight className="text-emerald-400" size={16}/>


                    {/* Partie droite : Test spécifique */}
                    <div className="bg-white p-2 px-4 rounded-lg shadow-sm border border-emerald-200 relative overflow-hidden flex-grow max-w-md">
                        <div className="absolute top-0 left-0 w-1 h-full bg-emerald-400"></div>
                        <p className="font-bold text-emerald-800 mb-1 uppercase text-[10px] tracking-wide">{data.testTitle}</p>
                        
                        <div className="flex flex-col gap-1">
                            {data.tests.map((test, idx) => (
                                <p key={idx} className="text-sm flex items-center gap-2 leading-tight">
                                    <CircleCheck className="text-emerald-500 shrink-0" size={14}/> {test.content}
                                </p>
                            ))}
                        </div>
                    </div>
                </div>
                {data.description && <p className="mt-2 text-emerald-700 text-xs italic text-center">{data.description}</p>}
            </div>
        );
    }


    // Visualisation : Liste de Règles
    if (type === 'rules') {
        return (
            <div className="bg-amber-50 p-6 rounded-xl border-2 border-amber-100 mb-6 flex flex-col items-center animate-in fade-in slide-in-from-bottom-4 duration-700">
                <h4 className="text-amber-800 font-bold uppercase tracking-wider text-sm mb-4 flex items-center gap-2">
                    <ListFilter size={18}/> Choix de la Règle
                </h4>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-lg">
                    {data.rules.map((rule, i) => (
                        <div key={i} className={`p-3 rounded-lg border-2 flex justify-between items-center ${rule.active ? 'bg-white border-amber-500 shadow-md transform scale-105' : 'bg-slate-50 border-slate-200 opacity-50'}`}>
                            <span className={`font-bold font-mono ${rule.active ? 'text-amber-700' : 'text-slate-500'}`}>{rule.code}</span>
                            <span className={`text-sm ${rule.active ? 'text-slate-800 font-bold' : 'text-slate-400'}`}>{rule.label}</span>
                            {rule.active && <CircleCheck className="text-amber-500" size={20}/>}
                        </div>
                    ))}
                </div>
                {data.description && <p className="mt-4 text-amber-800 text-sm font-bold text-center bg-amber-100 px-4 py-2 rounded-full">{data.description}</p>}
            </div>
        );
    }


    // Visualisation : Analyse de phrases (P9)
    if (type === 'sentence-analysis') {
        return (
            <div className="bg-purple-50 p-6 rounded-xl border-2 border-purple-100 mb-6 flex flex-col items-center animate-in fade-in slide-in-from-bottom-4 duration-700">
                <h4 className="text-purple-800 font-bold uppercase tracking-wider text-sm mb-4 flex items-center gap-2">
                    <Type size={18}/> Analyse des Phrases
                </h4>
                <div className="flex flex-col gap-4 w-full max-w-xl">
                    {/* Phrase 1 */}
                    <div className="bg-white p-3 rounded border-l-4 border-blue-400 shadow-sm">
                        <span className="text-xs font-bold text-blue-500 uppercase block mb-1">Phrase Syntaxique 1</span>
                        <div className="font-hand text-lg">
                            <span className="border-b-2 border-blue-300 mx-1 font-bold" title="Sujet">Ils</span>
                            <span className="bg-blue-100 px-1 rounded mx-1 font-bold" title="Verbe">utilisent</span>
                            l'écholocation
                        </div>
                    </div>
                    
                    {/* Indicateur de collision */}
                    <div className="flex justify-center items-center gap-2 text-red-500 font-bold bg-red-50 p-2 rounded-lg border border-red-200">
                        <ArrowRight className="rotate-90 md:rotate-0" size={20}/>
                        <span className="text-sm">IL FAUT UN MUR (POINT) ICI !</span>
                        <ArrowLeft className="rotate-90 md:rotate-0" size={20}/>
                    </div>


                    {/* Phrase 2 */}
                    <div className="bg-white p-3 rounded border-l-4 border-orange-400 shadow-sm">
                        <span className="text-xs font-bold text-orange-500 uppercase block mb-1">Phrase Syntaxique 2</span>
                        <div className="font-hand text-lg">
                            aussi 
                            <span className="border-b-2 border-orange-300 mx-1 font-bold" title="Sujet">cela</span>
                            <span className="bg-orange-100 px-1 rounded mx-1 font-bold" title="Verbe">permet</span>
                            de communiquer
                        </div>
                    </div>
                </div>
                {data.description && <p className="mt-4 text-purple-700 text-sm italic text-center max-w-lg">{data.description}</p>}
            </div>
        );
    }


    return null;
};


// --- COMPOSANTS UI ---
const Card = ({ children, className = "" }) => (
    <div className={`bg-white rounded-xl shadow-lg border-2 border-slate-200 overflow-hidden ${className}`}>
        {children}
    </div>
);


const Button = ({ onClick, children, variant = "primary", className = "" }) => {
    const baseStyle = "px-6 py-3 rounded-lg font-bold transition-all transform active:scale-95 flex items-center justify-center gap-2";
    const variants = {
        primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-md hover:shadow-lg",
        secondary: "bg-emerald-500 text-white hover:bg-emerald-600 shadow-md",
        outline: "border-2 border-slate-300 text-slate-600 hover:border-blue-500 hover:text-blue-600 bg-white",
        danger: "bg-red-500 text-white hover:bg-red-600"
    };
    return (
        <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`}>
            {children}
        </button>
    );
};


// --- ÉCRAN D'ACCUEIL ---
const Home = ({ changeMode }) => (
    <div className="flex flex-col items-center justify-center min-h-[80vh] text-center space-y-8 p-4">
        <div className="space-y-2">
            <h1 className="text-4xl md:text-6xl font-extrabold text-slate-800 tracking-tight font-comic">
                Profil de Scripteur
            </h1>
            <p className="text-xl text-slate-600 max-w-2xl mx-auto">
                Ton outil personnel pour analyser tes erreurs, comprendre tes défis et t'améliorer en français !
            </p>
        </div>
        
        <div className="w-full max-w-lg">
            <button onClick={() => changeMode('tutorial')} className="w-full group relative bg-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all border-l-8 border-blue-500 text-left">
                <div className="absolute top-4 right-4 bg-blue-100 p-2 rounded-full text-blue-600 group-hover:scale-110 transition-transform">
                    <BookOpen size={32} />
                </div>
                <h3 className="text-2xl font-bold text-slate-800 mb-2">Démarrer le Tutoriel Interactif</h3>
                <p className="text-slate-500">Apprends comment remplir ta grille, et surtout <strong>comment choisir le contexte</strong> étape par étape.</p>
                <div className="mt-6 flex items-center text-blue-600 font-bold">
                    Commencer <ArrowRight className="ml-2 group-hover:translate-x-2 transition-transform" size={20}/>
                </div>
            </button>
        </div>
    </div>
);


// --- TUTORIEL REVAMPED ---
const Tutorial = ({ goHome }) => {
    const [step, setStep] = useState(0);


    useEffect(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, [step]);


    // Les étapes du tutoriel
    const tutorialSteps = [
        // --- SÉQUENCE 1 : GN3 (Accord) ---
        {
            bubble: "Salut ! Je suis là pour t'aider. La partie la plus difficile, c'est de choisir le CONTEXTE (Colonne 1).",
            visual: null,
            focus: null,
            rowId: 1,
            content: { col1: "", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Règle #1 (Grammaire) : Pour corriger une faute d'accord, tu dois faire une HYPOTHÈSE. Qui est le chef (Donneur) ?",
            visual: {
                type: 'context',
                data: {
                    words: [
                        { text: "Les", highlight: "text-slate-400" },
                        { text: "bélugas", highlight: "bg-blue-100 text-blue-800 font-bold", label: "Donneur (Chef)", labelColor: "bg-blue-600 text-white", arrowColor: "border-t-blue-600", relation: true },
                        { text: "adulte", highlight: "bg-red-100 text-red-600 font-bold decoration-wavy underline", label: "Erreur (Receveur)", labelColor: "bg-red-500 text-white", arrowColor: "border-t-red-500" },
                        { text: "nagent", highlight: "text-slate-400" }
                    ],
                    description: "Pour prouver que 'adulte' prend un 's', tu es OBLIGÉ d'inclure 'bélugas' dans ton contexte."
                }
            },
            focus: null,
            rowId: 1,
            content: { col1: "", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "On commence donc par écrire le contexte.",
            visual: null,
            focus: "col1",
            rowId: 1,
            content: { col1: "les bélugas adulte", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Ensuite, regarde sur ta copie. Ton enseignant(e) a déjà indiqué la lettre du code (G, S, P ou U). Ici, c'est G.",
            visual: null,
            focus: "col2",
            rowId: 1,
            content: { col1: "les bélugas adulte", col2: "G...", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "STOP ! Avant de trouver le numéro de la règle, tu dois identifier la CLASSE du mot fautif. C'est le secret !",
            visual: null,
            focus: "col3",
            rowId: 1,
            content: { col1: "les bélugas adulte", col2: "G...", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Faisons une manipulation syntaxique. Par quoi peut-on remplacer 'adulte' ?",
            visual: {
                type: 'manipulation',
                data: {
                    word: "adulte",
                    testTitle: "Peut-on le remplacer par un Adjectif classifiant ?",
                    tests: [
                        { content: <span>les bélugas <span className="font-bold text-emerald-600">CANADIENS</span></span> },
                        { content: <span>les bélugas <span className="font-bold text-emerald-600">BLANCS</span></span> }
                    ],
                    description: "Comme on peut le remplacer par un autre adjectif classifiant, c'est bien un ADJECTIF."
                }
            },
            focus: "col3",
            rowId: 1,
            content: { col1: "les bélugas adulte", col2: "G...", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Tu peux maintenant indiquer 'Adj.' dans la colonne 3.",
            visual: null,
            focus: "col3",
            rowId: 1,
            content: { col1: "les bélugas adulte", col2: "G...", col3: "Adj.", col4: "", col5: "" }
        },
        {
            bubble: "Maintenant, regarde les règles G. Laquelle correspond à un Adjectif ?",
            visual: {
                type: 'rules',
                data: {
                    rules: [
                        { code: "GN1", label: "Nom" },
                        { code: "GN2", label: "Déterminant" },
                        { code: "GN3", label: "Adjectif / PPS", active: true },
                        { code: "GV1", label: "Verbe" }
                    ],
                    description: "C'est la règle GN3 (Groupe du Nom #3) car c'est un Adjectif !"
                }
            },
            focus: "col2",
            rowId: 1,
            content: { col1: "les bélugas adulte", col2: "G...", col3: "Adj.", col4: "", col5: "" }
        },
        {
            bubble: "On complète donc le code avec GN3.",
            visual: null,
            focus: "col2",
            rowId: 1,
            content: { col1: "les bélugas adulte", col2: "GN3", col3: "Adj.", col4: "", col5: "" }
        },
        {
            bubble: "Écris maintenant la correction. N'oublie pas de souligner ou mettre en gras ce que tu as corrigé !",
            visual: null,
            focus: "col4",
            rowId: 1,
            content: { 
                col1: "les bélugas adulte", 
                col2: "GN3", 
                col3: "Adj.", 
                col4: <span>les bélugas <span className="bg-yellow-200 font-bold px-1 rounded">adultes</span></span>, 
                col5: "" 
            }
        },
        {
            bubble: "Enfin, recopie TOUTE la règle associée à ton code (GN3).",
            visual: null,
            focus: "col5",
            rowId: 1,
            content: { 
                col1: "les bélugas adulte", 
                col2: "GN3", 
                col3: "Adj.", 
                col4: <span>les bélugas <span className="bg-yellow-200 font-bold px-1 rounded">adultes</span></span>, 
                col5: "L'adjectif s'accorde en genre et en nombre avec le nom." 
            }
        },


        // --- SÉQUENCE 1.5 : GV1 (Verbe - Les bélugas nage) ---
        {
            bubble: "Faisons une faute de Verbe (GV). Erreur : 'Les bélugas nage'.",
            visual: null,
            focus: null,
            rowId: 2,
            content: { col1: "", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Colonne 1 : Le contexte. Le sujet (Donneur) et le verbe (Receveur).",
            visual: {
                type: 'context',
                data: {
                    words: [
                        { text: "Les bélugas", highlight: "bg-blue-100 text-blue-800 font-bold", label: "Donneur (Sujet)", labelColor: "bg-blue-600 text-white", arrowColor: "border-t-blue-600", relation: true },
                        { text: "nage", highlight: "bg-red-100 text-red-600 font-bold decoration-wavy underline", label: "Erreur (Verbe)", labelColor: "bg-red-500 text-white", arrowColor: "border-t-red-500" },
                        { text: "vite", highlight: "text-slate-400" }
                    ],
                    description: "On doit voir le Sujet pour vérifier l'accord du Verbe."
                }
            },
            focus: "col1",
            rowId: 2,
            content: { col1: "les bélugas nage", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Lettre G. Classe : C'est un VERBE. On peut l'encadrer par 'ne...pas' (ne nage pas).",
            visual: null,
            focus: "col3",
            rowId: 2,
            content: { col1: "les bélugas nage", col2: "G...", col3: "Verbe", col4: "", col5: "" }
        },
        {
            bubble: "Regarde les règles G. C'est la GV1 (Verbe conjugué).",
            visual: {
                type: 'rules',
                data: {
                    rules: [
                        { code: "GN3", label: "Adjectif" },
                        { code: "GV1", label: "Verbe Conjugué", active: true },
                        { code: "GV2", label: "Participe Passé" }
                    ],
                    description: "C'est un verbe conjugué, donc GV1."
                }
            },
            focus: "col2",
            rowId: 2,
            content: { col1: "les bélugas nage", col2: "GV1", col3: "Verbe", col4: "", col5: "" }
        },
        {
            bubble: "IMPORTANT : Pour corriger un verbe, tu dois chercher sa conjugaison dans le Bescherelle ou sur Usito.",
            visual: null,
            focus: "col4",
            rowId: 2,
            content: { col1: "les bélugas nage", col2: "GV1", col3: "Verbe", col4: "", col5: "" }
        },
        {
            bubble: "Correction : 'nagent' (3e pers. pluriel).",
            visual: null,
            focus: "col4",
            rowId: 2,
            content: { 
                col1: "les bélugas nage", 
                col2: "GV1", 
                col3: "Verbe", 
                col4: <span>les bélugas <span className="bg-yellow-200 font-bold px-1 rounded">nagent</span></span>, 
                col5: "" 
            }
        },
        {
            bubble: "On copie la règle GV1.",
            visual: null,
            focus: "col5",
            rowId: 2,
            content: { 
                col1: "les bélugas nage", 
                col2: "GV1", 
                col3: "Verbe", 
                col4: <span>les bélugas <span className="bg-yellow-200 font-bold px-1 rounded">nagent</span></span>, 
                col5: "Le verbe s'accorde avec son sujet." 
            }
        },
        
        // --- SÉQUENCE 3 : U1 (Orthographe - Éléphant) ---
        {
            bubble: "Faisons maintenant un exemple d'Usage (U). Voici l'erreur : 'un éléphan'.",
            visual: null,
            focus: null,
            rowId: 3,
            content: { col1: "", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Colonne 1 : Recopie la faute avec son contexte.",
            visual: {
                type: 'context',
                data: {
                    words: [
                        { text: "C'est", highlight: "text-slate-400" },
                        { text: "un", highlight: "text-slate-600", label: "Déterminant", labelColor: "bg-blue-600 text-white", arrowColor: "border-t-blue-600" },
                        { text: "éléphan", highlight: "bg-red-100 text-red-600 font-bold decoration-wavy underline", label: "Erreur", labelColor: "bg-red-500 text-white", arrowColor: "border-t-red-500" },
                        { text: "gris", highlight: "text-slate-400" }
                    ],
                    description: "Pour U1, le mot seul suffit parfois, mais le déterminant aide à voir que c'est un Nom masculin."
                }
            },
            focus: "col1",
            rowId: 3,
            content: { col1: "un éléphan", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Ton enseignant(e) t'a donné la lettre U. Vérifions la classe. C'est un NOM, prouvons-le !",
            visual: {
                type: 'manipulation',
                data: {
                    word: "éléphant",
                    testTitle: "Peut-on mettre un déterminant devant ?",
                    tests: [
                        { content: <span><span className="font-bold text-emerald-600">UN</span> éléphant</span> },
                        { content: <span><span className="font-bold text-emerald-600">LE</span> gros éléphant</span> }
                    ],
                    description: "Ça fonctionne ! C'est donc un NOM."
                }
            },
            focus: "col3",
            rowId: 3,
            content: { col1: "un éléphan", col2: "U...", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Le code est U1 (Orthographe d'usage).",
            visual: null,
            focus: "col2",
            rowId: 3,
            content: { col1: "un éléphan", col2: "U1", col3: "Nom", col4: "", col5: "" }
        },
        {
            bubble: "Pour trouver la bonne orthographe, tu dois OBLIGATOIREMENT chercher dans le dictionnaire ou sur Usito.",
            visual: null,
            focus: "col4",
            rowId: 3,
            content: { 
                col1: "un éléphan", 
                col2: "U1", 
                col3: "Nom", 
                col4: <span>un éléphan<span className="bg-yellow-200 font-bold px-1 rounded">t</span></span>, 
                col5: "" 
            }
        },
        {
            bubble: "ATTENTION ! Pour U1, la règle est spéciale : Tu dois recopier le mot 5 FOIS.",
            visual: null,
            focus: "col5",
            rowId: 3,
            content: { 
                col1: "un éléphan", 
                col2: "U1", 
                col3: "Nom", 
                col4: <span>un éléphan<span className="bg-yellow-200 font-bold px-1 rounded">t</span></span>, 
                col5: "éléphant éléphant éléphant éléphant éléphant" 
            }
        },


        // --- SÉQUENCE 4 : U4 (Majuscule - Canada) ---
        {
            bubble: "Un autre exemple d'Usage (U), cette fois pour une Majuscule. Erreur : 'j'habite au canada'.",
            visual: null,
            focus: null,
            rowId: 4,
            content: { col1: "", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Colonne 1 : Le contexte. 'au canada'.",
            visual: {
                type: 'context',
                data: {
                    words: [
                        { text: "J'habite", highlight: "text-slate-400" },
                        { text: "au", highlight: "text-slate-400" },
                        { text: "canada", highlight: "bg-red-100 text-red-600 font-bold decoration-wavy underline", label: "Nom Propre (Lieu)", labelColor: "bg-red-500 text-white", arrowColor: "border-t-red-500" },
                        { text: "l'hiver", highlight: "text-slate-400" }
                    ],
                    description: "Le contexte montre que c'est un lieu géographique unique, donc un Nom Propre."
                }
            },
            focus: "col1",
            rowId: 4,
            content: { col1: "au canada", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Classe : C'est un NOM PROPRE. Faisons le test pour le prouver.",
            visual: {
                type: 'manipulation',
                data: {
                    word: "canada",
                    testTitle: "Peut-on mettre un déterminant devant ?",
                    tests: [
                        { content: <span><span className="font-bold text-emerald-600">UN</span> Canada</span> },
                        { content: <span><span className="font-bold text-emerald-600">LE</span> gros Canada</span> }
                    ],
                    description: "Ça fonctionne ! C'est donc un NOM."
                }
            },
            focus: "col3",
            rowId: 4,
            content: { col1: "au canada", col2: "U...", col3: "Nom p.", col4: "", col5: "" }
        },
        {
            bubble: "Le code U4 correspond à la Majuscule.",
            visual: null,
            focus: "col2",
            rowId: 4,
            content: { col1: "au canada", col2: "U4", col3: "Nom p.", col4: "", col5: "" }
        },
        {
            bubble: "Correction : On met la majuscule.",
            visual: null,
            focus: "col4",
            rowId: 4,
            content: { 
                col1: "au canada", 
                col2: "U4", 
                col3: "Nom p.", 
                col4: <span>au <span className="bg-yellow-200 font-bold px-1 rounded">C</span>anada</span>, 
                col5: "" 
            }
        },
        {
            bubble: "On copie la règle U4.",
            visual: null,
            focus: "col5",
            rowId: 4,
            content: { 
                col1: "au canada", 
                col2: "U4", 
                col3: "Nom p.", 
                col4: <span>au <span className="bg-yellow-200 font-bold px-1 rounded">C</span>anada</span>, 
                col5: "Majuscule dans le nom propre." 
            }
        },


         // --- SÉQUENCE 5 : S2 (Syntaxe - Négation) ---
        {
            bubble: "Passons à la Syntaxe (S). Erreur : 'les bélugas sont pas bleus'. Il manque quelque chose...",
            visual: null,
            focus: null,
            rowId: 5,
            content: { col1: "", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Colonne 1 : Attention ! Écrire juste 'sont pas' ne suffit pas. Je ne peux pas voir s'il manque le 'ne' ou non. Je préfère plus de contexte que moins !",
            visual: {
                type: 'context',
                data: {
                    words: [
                        { text: "Les bélugas", highlight: "text-slate-400" },
                        { text: "sont", highlight: "bg-blue-100 text-blue-800 font-bold", label: "Verbe", labelColor: "bg-blue-600 text-white", arrowColor: "border-t-blue-600", relation: true },
                        { text: "pas", highlight: "bg-red-100 text-red-600 font-bold decoration-wavy underline", label: "Négation incomplète", labelColor: "bg-red-500 text-white", arrowColor: "border-t-red-500" },
                        { text: "bleus", highlight: "text-slate-400" }
                    ],
                    description: "En mettant le mot AVANT le verbe, on prouve qu'il n'y a rien."
                }
            },
            focus: "col1",
            rowId: 5,
            content: { col1: "les bélugas sont pas", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "L'enseignant(e) a mis S. Vérifions si c'est bien une négation.",
            visual: {
                type: 'manipulation',
                data: {
                    word: "pas",
                    testTitle: "Doit-il encadrer le verbe ?",
                    tests: [
                        { content: <span><span className="font-bold text-emerald-600">NE</span> sont <span className="font-bold text-emerald-600">PAS</span></span> },
                        { content: <span><span className="font-bold text-emerald-600">N'</span>aime <span className="font-bold text-emerald-600">PAS</span></span> }
                    ],
                    description: "Oui, la négation a deux parties (lunettes). C'est un Adverbe de négation."
                }
            },
            focus: "col3",
            rowId: 5,
            content: { col1: "les bélugas sont pas", col2: "S...", col3: "Adv.", col4: "", col5: "" }
        },
        {
            bubble: "Le code S2 correspond à la Négation.",
            visual: null,
            focus: "col2",
            rowId: 5,
            content: { col1: "les bélugas sont pas", col2: "S2", col3: "Adv.", col4: "", col5: "" }
        },
        {
            bubble: "Correction : On ajoute le 'ne' (ou n').",
            visual: null,
            focus: "col4",
            rowId: 5,
            content: { 
                col1: "les bélugas sont pas", 
                col2: "S2", 
                col3: "Adv.", 
                col4: <span><span className="bg-yellow-200 font-bold px-1 rounded">ne</span> sont pas</span>, 
                col5: "" 
            }
        },
        {
            bubble: "Et on copie la règle S2.",
            visual: null,
            focus: "col5",
            rowId: 5,
            content: { 
                col1: "les bélugas sont pas", 
                col2: "S2", 
                col3: "Adv.", 
                col4: <span><span className="bg-yellow-200 font-bold px-1 rounded">ne</span> sont pas</span>, 
                col5: "La négation s'écrit toujours avec deux mots (ne... pas)." 
            }
        },


        // --- SÉQUENCE 6 : P9 (Ponctuation - Point) ---
        {
            bubble: "Enfin, la Ponctuation (P). Il manque un point entre 'écholocation' et 'aussi'. Mais 'écholocation aussi' ne suffit pas comme contexte.",
            visual: null,
            focus: null,
            rowId: 6,
            content: { col1: "", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Colonne 1 : Pour justifier un point, il faut prouver qu'il y a DEUX phrases syntaxiques complètes (Sujet + Verbe).",
            visual: {
                type: 'context',
                data: {
                    words: [
                        { text: "Ils", label: "Sujet 1", labelColor: "bg-blue-600 text-white", border: "border-b-4 border-blue-600" },
                        { text: "attrapent", label: "Verbe 1", labelColor: "bg-blue-600 text-white", highlight: "bg-blue-100" },
                        { text: "...l'écholocation", highlight: "text-slate-500" },
                        { text: "aussi", highlight: "bg-red-100 font-bold", label: "Mur manquant !", labelColor: "bg-red-500 text-white" },
                        { text: "cela", label: "Sujet 2", labelColor: "bg-orange-500 text-white", border: "border-b-4 border-orange-500" },
                        { text: "permet", label: "Verbe 2", labelColor: "bg-orange-500 text-white", highlight: "bg-orange-100" },
                        { text: "...", highlight: "text-slate-500" }
                    ],
                    description: "On a deux couples Sujet-Verbe. Il faut obligatoirement un point (un mur) entre les deux !"
                }
            },
            focus: "col1",
            rowId: 6,
            content: { col1: "Ils utilisent l'écholocation aussi cela permet de communiquer", col2: "", col3: "", col4: "", col5: "" }
        },
        {
            bubble: "Ton enseignant(e) a mis P. Pour la classe, on met souvent X ou Ponct.",
            visual: null,
            focus: "col3",
            rowId: 6,
            content: { col1: "Ils utilisent l'écholocation aussi cela permet de communiquer", col2: "P...", col3: "X", col4: "", col5: "" }
        },
        {
            bubble: "Le code P9 correspond à l'oubli du point.",
            visual: null,
            focus: "col2",
            rowId: 6,
            content: { col1: "Ils utilisent l'écholocation aussi cela permet de communiquer", col2: "P9", col3: "X", col4: "", col5: "" }
        },
        {
            bubble: "Correction : On ajoute le point et la majuscule !",
            visual: null,
            focus: "col4",
            rowId: 6,
            content: { 
                col1: "Ils utilisent l'écholocation aussi cela permet de communiquer", 
                col2: "P9", 
                col3: "X", 
                col4: <span>écholocation<span className="bg-yellow-200 font-bold px-1 rounded">. A</span>ussi</span>, 
                col5: "" 
            }
        },
        {
            bubble: "On copie la règle P9.",
            visual: null,
            focus: "col5",
            rowId: 6,
            content: { 
                col1: "Ils utilisent l'écholocation aussi cela permet de communiquer", 
                col2: "P9", 
                col3: "X", 
                col4: <span>écholocation<span className="bg-yellow-200 font-bold px-1 rounded">. A</span>ussi</span>, 
                col5: "Le point marque la fin d'une phrase déclarative." 
            }
        },
        {
            bubble: "Bravo ! Tu as vu des exemples pour G, U, S et P. À toi de jouer maintenant !",
            visual: null,
            focus: null,
            rowId: 6,
            content: { col1: "...", col2: "...", col3: "...", col4: "...", col5: "..." }
        }
    ];


    const currentData = tutorialSteps[step];
    
    // Calculer les lignes terminées pour les afficher en grisé
    const completedRows = [];
    if (currentData.rowId > 1) {
        completedRows.push({
             col1: "les bélugas adulte", col2: "GN3", col3: "Adj.", 
             col4: <span>les bélugas <span className="bg-yellow-200 font-bold px-1 rounded">adultes</span></span>, 
             col5: "L'adjectif s'accorde en genre et en nombre avec le nom."
        });
    }
    if (currentData.rowId > 2) {
        // GV1
        completedRows.push({
            col1: "les bélugas nage", col2: "GV1", col3: "Verbe", 
            col4: <span>les bélugas <span className="bg-yellow-200 font-bold px-1 rounded">nagent</span></span>, 
            col5: "Le verbe s'accorde avec son sujet."
       });
    }
    if (currentData.rowId > 3) {
         // U1
         completedRows.push({
             col1: "un éléphan", col2: "U1", col3: "Nom", 
             col4: <span>un éléphan<span className="bg-yellow-200 font-bold px-1 rounded">t</span></span>, 
             col5: "éléphant éléphant éléphant éléphant éléphant" 
         });
    }
    if (currentData.rowId > 4) {
        // U4
        completedRows.push({
            col1: "au canada", col2: "U4", col3: "Nom p.", 
            col4: <span>au <span className="bg-yellow-200 font-bold px-1 rounded">C</span>anada</span>, 
            col5: "Majuscule dans le nom propre." 
        });
   }
   if (currentData.rowId > 5) {
        // S2
        completedRows.push({
            col1: "les bélugas sont pas", col2: "S2", col3: "Adv.", 
            col4: <span><span className="bg-yellow-200 font-bold px-1 rounded">ne</span> sont pas</span>, 
            col5: "La négation s'écrit toujours avec deux mots (ne... pas)." 
        });
   }


    return (
        <div className="max-w-6xl mx-auto p-4 fade-in pb-32 flex flex-col min-h-screen">
            <div className="flex justify-between items-center mb-4">
                <button onClick={goHome} className="text-slate-500 hover:text-blue-600 flex items-center gap-1 font-bold">
                    <ArrowLeft size={20}/> Retour
                </button>
                <span className="text-slate-400 font-mono">Étape {step + 1}/{tutorialSteps.length}</span>
            </div>


            {/* Zone du Personnage et de la Bulle */}
            <div className="flex flex-col md:flex-row items-center justify-center gap-6 mb-8">
                <div className="relative shrink-0">
                    <div className="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center border-4 border-white shadow-lg">
                        <PenTool size={40} className="text-blue-600" />
                    </div>
                </div>
                
                <div className="relative bg-white p-6 rounded-2xl shadow-lg border-2 border-blue-100 max-w-2xl w-full">
                    <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-full md:left-0 md:-translate-x-full md:top-1/2 md:translate-y-0 md:ml-[-10px] w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-white md:border-t-[10px] md:border-t-transparent md:border-b-[10px] md:border-b-transparent md:border-r-[10px] md:border-r-white transform md:-rotate-180 rotate-0"></div>
                    <p className="text-lg md:text-xl font-hand font-bold text-slate-700 leading-snug">
                        {currentData.bubble}
                    </p>
                </div>
            </div>


            {/* Visualisateur Universel */}
            {currentData.visual && (
                <StepVisualizer type={currentData.visual.type} data={currentData.visual.data} />
            )}


            {/* La Grille Visuelle */}
            <div className="overflow-x-auto rounded-xl shadow-xl border border-slate-300 bg-white mb-8">
                <table className="w-full min-w-[800px] border-collapse">
                    <thead>
                        <tr className="bg-slate-100 text-slate-600 text-sm uppercase tracking-wider text-center">
                            <th className="p-3 border-r border-slate-200 w-1/4">1. Faute en contexte</th>
                            <th className="p-3 border-r border-slate-200 w-24">2. Code</th>
                            <th className="p-3 border-r border-slate-200 w-24">3. Classe</th>
                            <th className="p-3 border-r border-slate-200 w-1/4">4. Correction</th>
                            <th className="p-3 w-1/3">5. Règle à copier</th>
                        </tr>
                    </thead>
                    <tbody>
                        {/* Lignes complétées (Historique) */}
                        {completedRows.map((row, index) => (
                             <tr key={index} className="border-b border-slate-100 h-12 bg-slate-50/80 opacity-70 hover:opacity-100 transition-opacity">
                                <td className="p-2 border-r border-slate-200 align-middle font-hand text-base text-center text-slate-500 whitespace-nowrap overflow-hidden text-ellipsis max-w-[200px]">{row.col1}</td>
                                <td className="p-2 border-r border-slate-200 align-middle font-mono font-bold text-sm text-slate-500 text-center">{row.col2}</td>
                                <td className="p-2 border-r border-slate-200 align-middle text-slate-500 text-center text-sm italic">{row.col3}</td>
                                <td className="p-2 border-r border-slate-200 align-middle font-hand text-base text-green-700/70 text-center whitespace-nowrap overflow-hidden text-ellipsis max-w-[200px]">{row.col4}</td>
                                <td className="p-2 align-middle text-xs text-slate-400 whitespace-nowrap overflow-hidden text-ellipsis max-w-[300px]">{row.col5}</td>
                             </tr>
                        ))}


                        {/* Ligne active */}
                        <tr className="border-b border-slate-100 h-24 bg-white shadow-sm">
                            <td className={`p-3 border-r border-slate-200 align-middle transition-colors duration-300 relative ${currentData.focus === 'col1' ? 'bg-blue-50' : ''}`}>
                                <div className={`font-hand text-xl text-center transition-all duration-500 ${currentData.content.col1 ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'}`}>
                                    {currentData.content.col1}
                                </div>
                                {currentData.focus === 'col1' && <div className="absolute inset-0 border-4 border-blue-400 opacity-50 pointer-events-none animate-pulse"></div>}
                            </td>
                            <td className={`p-3 border-r border-slate-200 align-middle transition-colors duration-300 relative ${currentData.focus === 'col2' ? 'bg-blue-50' : ''}`}>
                                <div className={`font-mono font-bold text-lg text-blue-700 text-center transition-all duration-500 ${currentData.content.col2 ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'}`}>
                                    {currentData.content.col2}
                                </div>
                                {currentData.focus === 'col2' && <div className="absolute inset-0 border-4 border-blue-400 opacity-50 pointer-events-none animate-pulse"></div>}
                            </td>
                             <td className={`p-3 border-r border-slate-200 align-middle transition-colors duration-300 relative ${currentData.focus === 'col3' ? 'bg-blue-50' : ''}`}>
                                <div className={`text-slate-600 text-center italic transition-all duration-500 ${currentData.content.col3 ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'}`}>
                                    {currentData.content.col3}
                                </div>
                                {currentData.focus === 'col3' && <div className="absolute inset-0 border-4 border-blue-400 opacity-50 pointer-events-none animate-pulse"></div>}
                            </td>
                            <td className={`p-3 border-r border-slate-200 align-middle transition-colors duration-300 relative ${currentData.focus === 'col4' ? 'bg-blue-50' : ''}`}>
                                <div className={`font-hand text-xl text-green-700 text-center transition-all duration-500 ${currentData.content.col4 ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'}`}>
                                    {currentData.content.col4}
                                </div>
                                {currentData.focus === 'col4' && <div className="absolute inset-0 border-4 border-blue-400 opacity-50 pointer-events-none animate-pulse"></div>}
                            </td>
                            <td className={`p-3 align-middle transition-colors duration-300 relative ${currentData.focus === 'col5' ? 'bg-blue-50' : ''}`}>
                                <div className={`text-xs md:text-sm text-slate-600 transition-all duration-500 ${currentData.content.col5 ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'}`}>
                                    {currentData.content.col5}
                                </div>
                                {currentData.focus === 'col5' && <div className="absolute inset-0 border-4 border-blue-400 opacity-50 pointer-events-none animate-pulse"></div>}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>


            {/* Fixed Footer for Navigation */}
            <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-slate-200 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.1)] z-50 transition-all">
                <div className="max-w-6xl mx-auto flex justify-between items-center">
                    <Button variant="outline" onClick={() => setStep(Math.max(0, step - 1))} className={step === 0 ? "invisible" : ""}>
                        Précédent
                    </Button>
                    
                    {/* Indicateur de progression (points) */}
                    <div className="hidden md:flex gap-2">
                        {tutorialSteps.map((_, i) => (
                            <div key={i} className={`w-2 h-2 rounded-full transition-all ${i === step ? 'bg-blue-600 w-4' : 'bg-slate-300'}`}></div>
                        ))}
                    </div>


                    {step < tutorialSteps.length - 1 ? (
                        <Button onClick={() => setStep(step + 1)}>
                            Continuer <ArrowRight size={20}/>
                        </Button>
                    ) : (
                        <Button variant="secondary" onClick={goHome}>
                            J'ai compris ! <CircleCheck size={20}/>
                        </Button>
                    )}
                </div>
            </div>
        </div>
    );
};


// --- APP PRINCIPALE ---
export default function App() {
    const [mode, setMode] = useState('home');


    return (
        <div className="min-h-screen bg-slate-100 text-slate-900 pb-10 font-sans">
            {/* Injection des styles globaux et des polices */}
            <style>{`
                @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Patrick+Hand&family=Inter:wght@400;600&display=swap');
                .font-hand { font-family: 'Patrick Hand', cursive; }
                .font-comic { font-family: 'Comic Neue', cursive; }
                .font-sans { font-family: 'Inter', sans-serif; }
                .fade-in { animation: fadeIn 0.5s ease-in; }
                @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            `}</style>


            <nav className="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm sticky top-0 z-10">
                <div className="flex items-center gap-2 font-bold text-slate-700 cursor-pointer" onClick={() => setMode('home')}>
                    <PenTool className="text-blue-600"/>
                    <span className="hidden sm:inline">Classe de Français - Sec 1</span>
                </div>
                {mode !== 'home' && (
                    <button onClick={() => setMode('home')} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition">
                        <X size={20}/>
                    </button>
                )}
            </nav>


            <div className="container mx-auto mt-4 px-2 md:px-0">
                {mode === 'home' && <Home changeMode={setMode} />}
                {mode === 'tutorial' && <Tutorial goHome={() => setMode('home')} />}
            </div>
        </div>
    );
};