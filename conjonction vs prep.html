<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duel de Danse : Prép vs Conj</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <style>
        :root {
            /* Palette Battle */
            --bg-dark: #0f0f1a;
            --team-prep: #ff0055; /* Rouge Néon - Préposition */
            --team-conj: #00ccff; /* Bleu Néon - Conjonction */
            --neutral: #ffffff;
            --ui-panel: rgba(255, 255, 255, 0.05);
            
            --success: #39ff14;
            --error: #ff3333;
        }


        * { box-sizing: border-box; transition: all 0.3s ease; }


        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-dark);
            color: var(--neutral);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            background-image: 
                linear-gradient(115deg, rgba(255,0,85,0.1) 40%, transparent 40%),
                linear-gradient(115deg, transparent 60%, rgba(0,204,255,0.1) 60%);
        }


        /* --- HEADER --- */
        header {
            background: rgba(0,0,0,0.9);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #fff;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 5px 20px #000;
        }


        .battle-logo {
            font-family: 'Black Ops One', cursive;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(to right, var(--team-prep), #fff, var(--team-conj));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }


        .nav-controls { display: flex; gap: 15px; }
        
        .nav-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 45px; height: 45px;
            border-radius: 5px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .nav-btn:hover:not(:disabled) { background: #fff; color: #000; border-color: #fff; box-shadow: 0 0 10px #fff; }
        .nav-btn:disabled { opacity: 0.3; cursor: default; }


        .score-box {
            font-family: 'Black Ops One', cursive;
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            min-width: 100px;
            text-align: right;
        }


        /* --- MAIN STAGE --- */
        main {
            flex: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }


        .arena {
            width: 100%;
            max-width: 900px;
            background: var(--ui-panel);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }


        /* --- TYPOGRAPHY & TAGS --- */
        h2 {
            font-family: 'Black Ops One', cursive;
            text-transform: uppercase;
            text-align: center;
            font-size: 2rem;
            margin: 0 0 30px 0;
            background: linear-gradient(to bottom, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }


        .round-badge {
            position: absolute;
            top: 20px; left: 20px;
            background: #fff;
            color: #000;
            padding: 5px 15px;
            font-weight: 800;
            text-transform: uppercase;
            transform: skew(-10deg);
            font-size: 0.9rem;
        }


        .instruction {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: #ccc;
        }


        /* --- THEORIE (VS SCREEN) --- */
        .vs-screen {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .team-card {
            flex: 1;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid;
            background: rgba(0,0,0,0.3);
        }
        .team-prep { border-color: var(--team-prep); }
        .team-conj { border-color: var(--team-conj); }
        
        .team-title {
            font-family: 'Black Ops One', cursive;
            font-size: 1.5rem;
            text-transform: uppercase;
            margin-bottom: 15px;
            text-align: center;
        }
        .team-prep .team-title { color: var(--team-prep); text-shadow: 0 0 15px var(--team-prep); }
        .team-conj .team-title { color: var(--team-conj); text-shadow: 0 0 15px var(--team-conj); }


        .role-desc { font-size: 0.95rem; line-height: 1.6; }
        .role-desc strong { color: #fff; text-decoration: underline; }


        /* --- EXERCICE 1: CLASSIFICATION (BATTLE) --- */
        .word-display {
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            margin: 40px 0;
            text-shadow: 0 5px 10px rgba(0,0,0,0.5);
            animation: bounceIn 0.5s;
        }


        .battle-controls {
            display: flex;
            justify-content: center;
            gap: 40px;
        }


        .battle-btn {
            padding: 20px 40px;
            font-family: 'Black Ops One', cursive;
            font-size: 1.2rem;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            color: #fff;
            transform: skew(-10deg);
            position: relative;
            overflow: hidden;
        }
        .btn-prep { background: var(--team-prep); box-shadow: 5px 5px 0 rgba(100,0,30,0.8); }
        .btn-conj { background: var(--team-conj); box-shadow: 5px 5px 0 rgba(0,80,120,0.8); }
        
        .battle-btn:hover { transform: skew(-10deg) scale(1.05); }
        .battle-btn:active { transform: skew(-10deg) scale(0.95); }


        /* --- EXERCICE 2: CONTEXTE (TEXTE) --- */
        .sentence-container {
            font-size: 1.5rem;
            text-align: center;
            background: rgba(0,0,0,0.4);
            padding: 30px;
            border-radius: 10px;
            line-height: 1.8;
        }
        .target-word {
            display: inline-block;
            border-bottom: 3px solid #fff;
            padding: 0 5px;
            font-weight: 800;
        }


        /* --- EXERCICE 3: COMPLETION --- */
        .cloze-container {
            font-size: 1.3rem;
            line-height: 2;
            background: rgba(0,0,0,0.4);
            padding: 25px;
            border-radius: 10px;
        }
        
        /* --- EXERCICE 4: FREESTYLE (BANQUE) --- */
        .freestyle-text {
            font-size: 1.3rem;
            line-height: 2.5;
            margin-bottom: 30px;
        }
        .slot {
            display: inline-block;
            min-width: 120px;
            border-bottom: 2px solid #aaa;
            color: var(--success);
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            padding: 0 10px;
            background: rgba(255,255,255,0.05);
            margin: 0 5px;
        }
        .slot:hover { border-color: #fff; background: rgba(255,255,255,0.15); }
        .slot.filled { border-bottom: 2px solid var(--success); color: #fff; background: var(--team-conj); }
        .slot.filled-prep { background: var(--team-prep); } /* Optionnel si on veut distinguer */


        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
        }
        .bank-word {
            background: #333;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            border: 1px solid #555;
            text-transform: uppercase;
            font-family: 'Black Ops One', cursive;
            font-size: 1rem;
        }
        .bank-word:hover { background: #fff; color: #000; transform: translateY(-3px); }
        .bank-word.used { opacity: 0.3; pointer-events: none; transform: scale(0.9); }


        /* --- FEEDBACK --- */
        .feedback-overlay {
            margin-top: 20px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            min-height: 40px;
        }
        .correct-msg { color: var(--success); text-shadow: 0 0 10px var(--success); }
        .wrong-msg { color: var(--error); text-shadow: 0 0 10px var(--error); }


        .next-action-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 15px 40px;
            font-family: 'Black Ops One', cursive;
            font-size: 1.2rem;
            cursor: pointer;
            margin-top: 20px;
            display: none; /* Hidden initially */
            clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%);
        }
        .next-action-btn:hover {
            background: var(--success);
            color: #000;
            transform: scale(1.05);
        }


        /* --- ANIMATIONS --- */
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }


        /* --- START/END SCREEN --- */
        .start-btn {
            background: #fff;
            color: #000;
            font-family: 'Black Ops One', cursive;
            font-size: 1.5rem;
            padding: 15px 50px;
            border: none;
            cursor: pointer;
            margin-top: 30px;
            clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%);
        }
        .start-btn:hover { background: var(--team-conj); color: #fff; }


        /* Responsive */
        @media (max-width: 700px) {
            .battle-controls { flex-direction: column; align-items: center; gap: 20px; }
            .battle-btn { width: 100%; text-align: center; }
            .vs-screen { flex-direction: column; }
            h2 { font-size: 1.8rem; }
            header { padding: 10px 15px; }
            .battle-logo { font-size: 1rem; }
        }


        .hidden { display: none !important; }
    </style>
</head>
<body>


<header>
    <div class="battle-logo"><i class="fas fa-bolt"></i> DANCE BATTLE</div>
    
    <div class="nav-controls">
        <button class="nav-btn" id="prev-btn" onclick="prevStep()" title="Précédent"><i class="fas fa-chevron-left"></i></button>
        <button class="nav-btn" id="next-btn" onclick="nextStep()" title="Suivant"><i class="fas fa-chevron-right"></i></button>
    </div>


    <div class="score-box" id="score">0 PTS</div>
</header>


<main>
    <div class="arena" id="game-area">
        <!-- Content injected via JS -->
    </div>
</main>


<script>
    /* --- DONNÉES PÉDAGOGIQUES --- */
    const content = {
        intro: {
            title: "LE DUEL FINAL",
            html: `
                <div class="vs-screen">
                    <div class="team-card team-prep">
                        <div class="team-title">TEAM PRÉPOSITION</div>
                        <div class="role-desc">
                            <i class="fas fa-anchor"></i> <strong>Rôle :</strong> Introduit un complément.<br>
                            <i class="fas fa-link"></i> <strong>Relie :</strong> Un mot à un autre mot (souvent de nature différente).<br>
                            <i class="fas fa-users"></i> <strong>Membres :</strong> À, de, par, pour, sans, avec, dans, sur, grâce à, à cause de...
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; justify-content:center; font-size:3rem; font-family:'Black Ops One';">VS</div>
                    <div class="team-card team-conj">
                        <div class="team-title">TEAM CONJONCTION</div>
                        <div class="role-desc">
                            <i class="fas fa-project-diagram"></i> <strong>Rôle :</strong> Joint deux éléments.<br>
                            <i class="fas fa-link"></i> <strong>Relie :</strong> Deux phrases ou deux mots de même nature.<br>
                            <i class="fas fa-users"></i> <strong>Membres :</strong> Mais, ou, et, donc, car, parce que, bien que, pour que...
                        </div>
                    </div>
                </div>
                <p class="instruction">Prouve que tu sais les différencier pour gagner le trophée !</p>
                <div style="text-align:center;">
                    <button class="start-btn" onclick="startGame()">ENTRER DANS L'ARÈNE</button>
                </div>
            `
        },
        round1: {
            title: "ROUND 1 : CLASSEMENT RAPIDE",
            instruction: "Ce mot ou cette locution appartient à quelle équipe ?",
            words: [
                { text: "GRÂCE À", type: "prep", hint: "Locution prépositive (ex: Grâce à toi)" },
                { text: "MAIS", type: "conj", hint: "Relie deux idées opposées" },
                { text: "AFIN DE", type: "prep", hint: "Locution prépositive + Infinitif (ex: Afin de réussir)" },
                { text: "CAR", type: "conj", hint: "Relie deux phrases (Cause)" },
                { text: "BIEN QUE", type: "conj", hint: "Locution conjonctive + Subjonctif" },
                { text: "À CAUSE DE", type: "prep", hint: "Locution prépositive (Cause négative)" },
                { text: "QUAND", type: "conj", hint: "Relie une phrase de temps" },
                { text: "POUR QUE", type: "conj", hint: "Locution conjonctive (But)" }
            ]
        },
        round2: {
            title: "ROUND 2 : ANALYSE DU MOUVEMENT",
            instruction: "Le mot en évidence est-il une Préposition ou une Conjonction ?",
            sentences: [
                { html: "Il danse <span class='target-word'>avec</span> passion.", type: "prep", explanation: "'Avec' introduit le nom 'passion'." },
                { html: "Il tombe, <span class='target-word'>mais</span> il se relève.", type: "conj", explanation: "'Mais' relie deux propositions (tomber / se relever)." },
                { html: "Elle s'arrête, <span class='target-word'>car</span> la musique est finie.", type: "conj", explanation: "'Car' relie deux phrases complètes." },
                { html: "Elle s'arrête <span class='target-word'>pour</span> boire de l'eau.", type: "prep", explanation: "'Pour' introduit un infinitif (boire)." },
                { html: "Il a réussi <span class='target-word'>grâce à</span> son travail.", type: "prep", explanation: "'Grâce à' introduit un groupe nominal." },
                { html: "Il est fort, <span class='target-word'>bien qu'</span>il soit fatigué.", type: "conj", explanation: "'Bien que' introduit une phrase au subjonctif." }
            ]
        },
        round3: {
            title: "ROUND 3 : LE CYPHER (TEXTE À TROUS)",
            instruction: "Choisis le bon mot. Attention à la ponctuation et au sens.",
            questions: [
                { text: "Le danseur reste ___ la scène.", options: [{txt:"sur", type:"prep"}, {txt:"car", type:"conj"}], correct: "sur", context: "Lieu (prép)" },
                { text: "Le public l'applaudit, ___ il a été génial.", options: [{txt:"sur", type:"prep"}, {txt:"car", type:"conj"}], correct: "car", context: "Cause (phrase complète)" },
                { text: "Il s'entraîne ___ gagner la compétition.", options: [{txt:"pour", type:"prep"}, {txt:"donc", type:"conj"}], correct: "pour", context: "But + Infinitif" },
                { text: "Il s'est blessé, ___ il ne peut pas danser.", options: [{txt:"pour", type:"prep"}, {txt:"donc", type:"conj"}], correct: "donc", context: "Conséquence" }
            ]
        },
        round4: {
            title: "ROUND 4 : LE FREESTYLE",
            instruction: "Complète le texte en utilisant les mots de la banque. Clique sur un mot pour le placer dans la case vide.",
            questions: [
                {
                    text: "Le spectacle continue, [slot] la fatigue se fasse sentir. Les danseurs bougent [slot] leur énergie inépuisable. Ils ne s'arrêtent pas, [slot] le public en redemande. Tout est prêt [slot] le final.",
                    slots: [
                        { answer: "bien que", type: "conj" }, 
                        { answer: "grâce à", type: "prep" }, 
                        { answer: "car", type: "conj" }, 
                        { answer: "pour", type: "prep" }
                    ],
                    bank: ["pour", "bien que", "car", "grâce à"]
                },
                {
                    text: "Il porte des baskets [slot] être à l'aise. [slot] le rythme accélère, il ne perd pas le fil. Il est fatigué, [slot] il sourit. C'est [slot] sa passion qu'il continue.",
                    slots: [
                        { answer: "pour", type: "prep" },
                        { answer: "Lorsque", type: "conj" },
                        { answer: "mais", type: "conj" },
                        { answer: "grâce à", type: "prep" }
                    ],
                    bank: ["pour", "Lorsque", "mais", "grâce à"]
                },
                {
                    text: "Elle danse [slot] élégance. C'est beau, [slot] c'est difficile. [slot] elle a mal aux pieds, elle garde la pose. Elle ne bouge pas [slot] le rideau tombe.",
                    slots: [
                        { answer: "avec", type: "prep" },
                        { answer: "mais", type: "conj" },
                        { answer: "Bien qu'", type: "conj" },
                        { answer: "jusqu'à ce que", type: "conj" }
                    ],
                    bank: ["Bien qu'", "jusqu'à ce que", "avec", "mais"]
                }
            ]
        }
    };


    /* --- ÉTAT DU JEU --- */
    let currentState = {
        phase: 'intro', // intro, round1, round2, round3, round4, end
        index: 0,
        score: 0,
        maxScore: 0,
        answered: false,
        round4State: {
            placedWords: [null, null, null, null], // Tracks words in slots
            scoreGiven: false
        }
    };


    // Calculate total questions for score
    const TOTAL_QUESTIONS = content.round1.words.length + content.round2.sentences.length + content.round3.questions.length + content.round4.questions.length;
    const MAX_POSSIBLE_SCORE = TOTAL_QUESTIONS * 10;


    /* --- MOTEUR D'AFFICHAGE --- */
    function init() {
        render();
        updateNav();
    }


    function startGame() {
        currentState.phase = 'round1';
        currentState.index = 0;
        currentState.score = 0;
        render();
        updateNav();
    }


    function render() {
        const arena = document.getElementById('game-area');
        const scoreDisplay = document.getElementById('score');
        scoreDisplay.innerText = currentState.score + " PTS";
        
        // Don't reset answered state if just re-rendering same step (unless specifically handled)
        // Here we rely on navigation functions to reset logic


        // Nettoyage
        arena.innerHTML = '';


        if (currentState.phase === 'intro') {
            arena.innerHTML = `<h2><i class="fas fa-handshake"></i> ${content.intro.title}</h2>${content.intro.html}`;
        } 
        else if (currentState.phase === 'round1') {
            renderRound1(arena);
        } 
        else if (currentState.phase === 'round2') {
            renderRound2(arena);
        }
        else if (currentState.phase === 'round3') {
            renderRound3(arena);
        }
        else if (currentState.phase === 'round4') {
            renderRound4(arena);
        }
        else if (currentState.phase === 'end') {
            renderEnd(arena);
        }
    }


    /* --- RENDERERS SPÉCIFIQUES --- */


    function renderRound1(container) {
        const item = content.round1.words[currentState.index];
        container.innerHTML = `
            <div class="round-badge">ROUND 1 • ${currentState.index + 1}/${content.round1.words.length}</div>
            <h2>${content.round1.title}</h2>
            <p class="instruction">${content.round1.instruction}</p>
            
            <div class="word-display">${item.text}</div>
            
            <div class="battle-controls">
                <button class="battle-btn btn-prep" onclick="handleChoice('prep')"><i class="fas fa-anchor"></i> PRÉPOSITION</button>
                <button class="battle-btn btn-conj" onclick="handleChoice('conj')"><i class="fas fa-project-diagram"></i> CONJONCTION</button>
            </div>
            <div id="feedback" class="feedback-overlay"></div>
            <div style="text-align:center;"><button class="next-action-btn" id="next-action" onclick="nextStep()">ROUND SUIVANT <i class="fas fa-forward"></i></button></div>
        `;
        restoreFeedbackIfAnswered();
    }


    function renderRound2(container) {
        const item = content.round2.sentences[currentState.index];
        container.innerHTML = `
            <div class="round-badge">ROUND 2 • ${currentState.index + 1}/${content.round2.sentences.length}</div>
            <h2>${content.round2.title}</h2>
            <p class="instruction">${content.round2.instruction}</p>
            
            <div class="sentence-container">${item.html}</div>
            <br>
            <div class="battle-controls">
                <button class="battle-btn btn-prep" onclick="handleChoice('prep')">C'est une PRÉPOSITION</button>
                <button class="battle-btn btn-conj" onclick="handleChoice('conj')">C'est une CONJONCTION</button>
            </div>
            <div id="feedback" class="feedback-overlay"></div>
            <div style="text-align:center;"><button class="next-action-btn" id="next-action" onclick="nextStep()">ROUND SUIVANT <i class="fas fa-forward"></i></button></div>
        `;
        restoreFeedbackIfAnswered();
    }


    function renderRound3(container) {
        const item = content.round3.questions[currentState.index];
        const parts = item.text.split("___");
        
        container.innerHTML = `
            <div class="round-badge">ROUND 3 • ${currentState.index + 1}/${content.round3.questions.length}</div>
            <h2>${content.round3.title}</h2>
            <p class="instruction">${content.round3.instruction}</p>
            
            <div class="cloze-container" style="text-align:center;">
                ${parts[0]} 
                <span id="slot-${currentState.index}" style="border-bottom:2px solid #fff; padding:0 10px; color:#aaa;">?</span> 
                ${parts[1]}
            </div>
            <br>
            <div class="battle-controls">
                <button class="battle-btn" style="border:1px solid #fff; background:transparent;" onclick="handleChoice('${item.options[0].txt.replace(/'/g, "\\'")}')">${item.options[0].txt.toUpperCase()}</button>
                <button class="battle-btn" style="border:1px solid #fff; background:transparent;" onclick="handleChoice('${item.options[1].txt.replace(/'/g, "\\'")}')">${item.options[1].txt.toUpperCase()}</button>
            </div>
            <div id="feedback" class="feedback-overlay"></div>
            <div style="text-align:center;"><button class="next-action-btn" id="next-action" onclick="nextStep()">ROUND SUIVANT <i class="fas fa-forward"></i></button></div>
        `;
        restoreFeedbackIfAnswered();
    }


    function renderRound4(container) {
        const questionData = content.round4.questions[currentState.index];
        
        // Initialization check specifically for Round 4 array
        // We use placedWords array size to determine reset needed if length mismatches slots
        if (currentState.round4State.placedWords.length !== questionData.slots.length) {
             currentState.round4State.placedWords = new Array(questionData.slots.length).fill(null);
             currentState.round4State.scoreGiven = false;
             currentState.answered = false;
        }


        // Construct Text HTML
        let textHTML = questionData.text;
        questionData.slots.forEach((s, idx) => {
            const word = currentState.round4State.placedWords[idx];
            // If filled, show word. If correct/incorrect validated, show style
            let slotClass = "slot";
            if(word) slotClass += " filled";
            
            const slotHtml = `<span class="${slotClass}" onclick="round4RemoveWord(${idx})">${word || "____"}</span>`;
            textHTML = textHTML.replace('[slot]', slotHtml);
        });


        // Bank Buttons
        let bankHTML = '';
        questionData.bank.forEach((word) => {
            const isUsed = currentState.round4State.placedWords.includes(word);
            const safeWord = word.replace(/'/g, "\\'");
            bankHTML += `<div class="bank-word ${isUsed ? 'used' : ''}" onclick="round4PlaceWord('${safeWord}')">${word}</div>`;
        });


        container.innerHTML = `
            <div class="round-badge">ROUND 4 • ${currentState.index + 1}/${content.round4.questions.length}</div>
            <h2>${content.round4.title}</h2>
            <p class="instruction">${content.round4.instruction}</p>
            
            <div class="cloze-container freestyle-text">
                ${textHTML}
            </div>


            <div class="word-bank">
                ${bankHTML}
            </div>


            <div id="feedback" class="feedback-overlay"></div>
            <div style="text-align:center;">
                <button class="start-btn" id="check-r4" onclick="round4Check()" style="margin-top:20px; font-size:1.2rem;">VALIDER</button>
                <button class="next-action-btn" id="next-action" onclick="nextStep()">TEXTE SUIVANT <i class="fas fa-forward"></i></button>
            </div>
        `;
        
        if(currentState.answered) {
            document.getElementById('check-r4').style.display = 'none';
            document.getElementById('next-action').style.display = 'inline-block';
            // Show result text again
            round4Check(true); // true = just show feedback, don't score
        }
    }


    function renderEnd(container) {
        const percent = Math.round((currentState.score / MAX_POSSIBLE_SCORE) * 100);
        let msg = "";
        let color = "#fff";


        if(percent >= 80) {
            msg = "VICTOIRE TOTALE ! Tu es le champion de la grammaire.";
            color = "var(--success)";
        } else {
            msg = "BIEN JOUÉ, mais il faut encore t'entraîner pour gagner le battle.";
            color = "var(--team-conj)";
        }


        container.innerHTML = `
            <h2>BATTLE TERMINÉ</h2>
            <div style="font-size:4rem; font-family:'Black Ops One'; color:${color}; text-shadow:0 0 20px ${color}; text-align:center;">
                ${currentState.score} PTS
            </div>
            <p class="instruction" style="margin-top:20px;">${msg}</p>
            <div style="text-align:center;">
                <button class="start-btn" onclick="location.reload()"><i class="fas fa-redo"></i> RECOMMENCER</button>
            </div>
        `;
        document.getElementById('prev-btn').disabled = true;
        document.getElementById('next-btn').disabled = true;
    }


    function restoreFeedbackIfAnswered() {
        if(currentState.answered) {
            const fb = document.getElementById('feedback');
            fb.innerHTML = "<span style='color:#ccc'>(Déjà validé)</span>";
            document.getElementById('next-action').style.display = 'inline-block';
        }
    }


    /* --- LOGIQUE ROUND 4 --- */
    function round4PlaceWord(word) {
        if(currentState.answered) return;
        const emptyIndex = currentState.round4State.placedWords.findIndex(w => w === null);
        if (emptyIndex !== -1) {
            currentState.round4State.placedWords[emptyIndex] = word;
            renderRound4(document.getElementById('game-area'));
        }
    }


    function round4RemoveWord(index) {
        if(currentState.answered) return;
        currentState.round4State.placedWords[index] = null;
        renderRound4(document.getElementById('game-area'));
    }


    function round4Check(repaintOnly = false) {
        if(!repaintOnly && currentState.answered) return;
        
        const questionData = content.round4.questions[currentState.index];


        // Check filled
        if(!repaintOnly && currentState.round4State.placedWords.includes(null)) {
            document.getElementById('feedback').innerHTML = "<span style='color:orange'>Remplis tous les trous d'abord !</span>";
            return;
        }


        currentState.answered = true;
        let correctCount = 0;


        questionData.slots.forEach((slot, i) => {
            const userWord = currentState.round4State.placedWords[i];
            if(userWord === slot.answer) {
                correctCount++;
            }
        });


        if(!repaintOnly && !currentState.round4State.scoreGiven) {
            if(correctCount === questionData.slots.length) currentState.score += 10;
            currentState.round4State.scoreGiven = true;
            document.getElementById('score').innerText = currentState.score + " PTS";
        }


        const fb = document.getElementById('feedback');
        if(correctCount === questionData.slots.length) {
            fb.innerHTML = `<span class="correct-msg">FREESTYLE PARFAIT !</span>`;
        } else {
            fb.innerHTML = `<span class="wrong-msg">Erreurs (${correctCount}/${questionData.slots.length} corrects).</span>`;
        }
        
        document.getElementById('check-r4').style.display = 'none';
        document.getElementById('next-action').style.display = 'inline-block';
        updateNav();
    }


    /* --- LOGIQUE GÉNÉRALE JEU --- */


    function handleChoice(userChoice) {
        if(currentState.answered) return; 
        currentState.answered = true;


        const fb = document.getElementById('feedback');
        let isCorrect = false;
        let correctData;


        if (currentState.phase === 'round1') {
            const data = content.round1.words[currentState.index];
            isCorrect = (userChoice === data.type);
            correctData = data;
            const wDisplay = document.querySelector('.word-display');
            wDisplay.style.color = data.type === 'prep' ? 'var(--team-prep)' : 'var(--team-conj)';
        } 
        else if (currentState.phase === 'round2') {
            const data = content.round2.sentences[currentState.index];
            isCorrect = (userChoice === data.type);
            correctData = data;
        }
        else if (currentState.phase === 'round3') {
            const data = content.round3.questions[currentState.index];
            isCorrect = (userChoice === data.correct);
            correctData = data;
            const slot = document.getElementById(`slot-${currentState.index}`);
            slot.innerText = userChoice.toUpperCase();
            slot.style.color = isCorrect ? 'var(--success)' : 'var(--error)';
        }


        if (isCorrect) {
            currentState.score += 10;
            document.getElementById('score').innerText = currentState.score + " PTS";
            fb.innerHTML = `<span class="correct-msg"><i class="fas fa-check-circle"></i> CORRECT !</span>`;
            if(correctData.explanation) fb.innerHTML += ` <div style="font-size:0.9rem; color:#ccc; margin-top:5px;">${correctData.explanation}</div>`;
            else if(correctData.hint) fb.innerHTML += ` <div style="font-size:0.9rem; color:#ccc; margin-top:5px;">${correctData.hint}</div>`;
        } else {
            fb.innerHTML = `<span class="wrong-msg"><i class="fas fa-times-circle"></i> AÏE !</span>`;
            let rightAnswer = "";
            if(currentState.phase === 'round3') rightAnswer = `C'était "${correctData.correct.toUpperCase()}"`;
            else rightAnswer = `C'est une ${correctData.type === 'prep' ? 'PRÉPOSITION' : 'CONJONCTION'}`;
            
            fb.innerHTML += ` <div style="font-size:0.9rem; color:#fff; margin-top:5px;">${rightAnswer}.</div>`;
            if(correctData.explanation) fb.innerHTML += ` <div style="font-size:0.9rem; color:#ccc;">${correctData.explanation}</div>`;
        }


        document.getElementById('next-action').style.display = 'inline-block';
        updateNav();
    }


    /* --- NAVIGATION --- */


    function nextStep() {
        if(currentState.phase === 'intro') { startGame(); return; }
        if(currentState.phase === 'end') return;


        // Reset Round 4 specific state if moving
        currentState.round4State = { placedWords: [], scoreGiven: false }; 


        let currentMax = 0;
        if(currentState.phase === 'round1') currentMax = content.round1.words.length;
        if(currentState.phase === 'round2') currentMax = content.round2.sentences.length;
        if(currentState.phase === 'round3') currentMax = content.round3.questions.length;
        if(currentState.phase === 'round4') currentMax = content.round4.questions.length;


        if (currentState.index < currentMax - 1) {
            currentState.index++;
            currentState.answered = false; // Reset for new question
            render();
        } else {
            currentState.index = 0;
            currentState.answered = false;
            
            if(currentState.phase === 'round1') currentState.phase = 'round2';
            else if(currentState.phase === 'round2') currentState.phase = 'round3';
            else if(currentState.phase === 'round3') currentState.phase = 'round4';
            else if(currentState.phase === 'round4') currentState.phase = 'end';
            render();
        }
        updateNav();
    }


    function prevStep() {
        if(currentState.phase === 'intro' || currentState.phase === 'end') return;


        currentState.round4State = { placedWords: [], scoreGiven: false }; 


        if (currentState.index > 0) {
            currentState.index--;
            currentState.answered = true; 
            render();
        } else {
            if(currentState.phase === 'round2') {
                currentState.phase = 'round1';
                currentState.index = content.round1.words.length - 1;
            } else if(currentState.phase === 'round3') {
                currentState.phase = 'round2';
                currentState.index = content.round2.sentences.length - 1;
            } else if(currentState.phase === 'round4') {
                currentState.phase = 'round3';
                currentState.index = content.round3.questions.length - 1;
            }
            currentState.answered = true;
            render();
        }
        updateNav();
    }


    function updateNav() {
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');


        if(currentState.phase === 'intro' || currentState.phase === 'end') {
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            return;
        }


        // Next button in header is enabled only if answered (force user to complete)
        nextBtn.disabled = !currentState.answered;
        prevBtn.disabled = (currentState.phase === 'round1' && currentState.index === 0);
    }


    // Init
    init();


</script>
</body>
</html>