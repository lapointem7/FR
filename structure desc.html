<!DOCTYPE html>
<html lang="fr-CA">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atelier : L'Archéologie du Texte</title>
    <!-- Google Fonts: Merriweather (Titres classiques) & Lato (Texte moderne) -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <style>
        :root {
            /* Palette Archéologie / Découverte */
            --primary: #5D4037; /* Brun Terre */
            --primary-grad: linear-gradient(135deg, #5D4037, #8D6E63);
            
            --accent: #D84315; /* Terre cuite / Orange brûlé */
            --accent-grad: linear-gradient(135deg, #D84315, #F4511E);
            
            --success: #2E7D32; /* Vert Jungle */
            --success-grad: linear-gradient(135deg, #2E7D32, #43A047);
            
            --gold: #FFB300; /* Or antique */
            
            --bg-color: #FDF5E6; /* Vieux papier / Sable */
            --text-color: #3E2723;
            --card-bg: #ffffff;
            --texture: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjRkRGNUU2Ii8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNFMEQ2Q0MiLz4KPC9zdmc+');
        }


        * { box-sizing: border-box; }


        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-color);
            background-image: var(--texture); /* Texture subtile */
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }


        h1, h2, h3, h4 { font-family: 'Merriweather', serif; color: var(--primary); margin-top: 0; letter-spacing: 0.5px; }


        /* HEADER AVENTURE */
        header {
            background: var(--primary-grad);
            color: #FFECB3;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(62, 39, 35, 0.4);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 4px solid var(--gold);
        }


        .logo { font-size: 1.4rem; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; }
        .header-info { display: flex; gap: 15px; }
        .badge { 
            background: rgba(0,0,0,0.3); 
            padding: 6px 14px; 
            border-radius: 4px; /* Plus carré pour le style classique */
            font-size: 0.9rem; 
            font-weight: 700;
            border: 1px solid var(--gold);
            color: var(--gold);
        }


        /* CONTAINER */
        main {
            flex: 1;
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px 50px 20px;
            width: 100%;
        }


        /* SLIDES ANIMATIONS */
        .slide { display: none; opacity: 0; transform: translateY(10px); transition: all 0.5s ease-out; }
        .slide.active { display: block; opacity: 1; transform: translateY(0); }


        /* CARDS PARCHEMIN */
        .card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(62, 39, 35, 0.15);
            margin-bottom: 25px;
            border: 1px solid #D7CCC8;
            position: relative;
        }
        
        /* Coin décoratif */
        .card::after {
            content: '';
            position: absolute;
            top: 0; right: 0;
            border-width: 0 40px 40px 0;
            border-style: solid;
            border-color: transparent var(--gold) transparent transparent;
            opacity: 0.8;
        }


        /* BUTTONS EXPLORATEUR */
        .btn {
            background: var(--primary-grad);
            color: #FFECB3;
            border: 2px solid var(--primary);
            padding: 12px 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            font-family: 'Merriweather', serif;
            font-weight: 700;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 0px #3E2723; /* Effet 3D */
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0px #3E2723; }
        .btn:active { transform: translateY(2px); box-shadow: 0 0 0 #3E2723; }
        
        .btn-secondary { 
            background: var(--accent-grad); 
            border-color: #BF360C;
            color: white;
            box-shadow: 0 4px 0px #BF360C;
        }
        .btn-secondary:hover { box-shadow: 0 6px 0px #BF360C; }
        
        .center-btn { text-align: center; margin-top: 30px; }


        /* --- JEU 1 : ASSOCIATION --- */
        .grid-match {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }


        .match-card {
            background: #FFF8E1;
            border: 2px solid #D7CCC8;
            padding: 20px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            position: relative;
        }


        .match-card:hover { border-color: var(--primary); background: #FFE0B2; }
        .match-card.selected { border-color: var(--primary); background: var(--primary); color: white; transform: scale(1.02); }
        .match-card.matched { border-color: var(--success); background: #E8F5E9; cursor: default; }


        .card-badge {
            font-size: 0.7rem;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: none;
            letter-spacing: 1px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .card-badge.neutre { background: #ECEFF1; color: #455A64; }
        .card-badge.accro { background: #FFECB3; color: #E65100; border-color: #FFB300; }


        .match-card.error { animation: shake 0.4s; border-color: var(--accent); background: #FFCCBC; }


        /* --- JEU 2 : ARBRE ARCHÉOLOGIQUE --- */
        .text-reader {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #D7CCC8;
            padding: 25px;
            border-radius: 6px;
            background: #FFFDE7; /* Papier ancien */
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 1.15rem;
            font-family: 'Lato', serif;
            color: #3E2723;
        }
        .text-reader p { margin-bottom: 15px; text-align: justify; }
        .marker { font-weight: bold; color: var(--accent); } /* Pour mettre en valeur les connecteurs */


        .tree-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding-bottom: 20px;
        }


        .tree-node-main {
            width: 90%;
            max-width: 500px;
            margin-bottom: 40px;
            position: relative;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid var(--primary);
            z-index: 2;
        }
        
        .tree-connector-v {
            position: absolute;
            bottom: -40px; left: 50%;
            width: 4px; height: 40px;
            background: var(--primary);
            z-index: 1;
        }
        
        .aspects-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
            position: relative;
            flex-wrap: wrap; /* Sécurité pour mobile */
        }
        
        .aspects-row::before {
            content: '';
            position: absolute;
            top: -20px; 
            left: 15%; right: 15%;
            height: 4px;
            background: var(--primary);
            z-index: 1;
        }


        .aspect-column {
            flex: 1;
            min-width: 250px;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            border: 2px dashed #A1887F;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .aspect-column::before { 
            content: '';
            position: absolute;
            top: -20px; left: 50%;
            width: 4px; height: 20px;
            background: var(--primary);
        }


        .input-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #BCAAA4;
            border-radius: 4px;
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
            background: #FAFAFA;
        }
        .input-box:focus { border-color: var(--primary); outline: none; background: #fff; border-width: 2px; }


        .label-tag {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--primary);
            font-weight: 900;
            margin-bottom: 5px;
            display: block;
        }


        .correction {
            display: none;
            background: #E8F5E9;
            color: #1B5E20;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.95rem;
            margin-top: 8px;
            border-left: 4px solid var(--success);
            font-style: italic;
        }
        .correction.show { display: block; }


        /* --- JEU 3 : HIERARCHIE (COMPACTE) --- */
        .hierarchy-game {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Plus serré car 7 éléments */
            margin-top: 20px;
        }
        .h-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 12px 15px; /* Plus compact */
            border-radius: 6px;
            border: 1px solid #D7CCC8;
            transition: transform 0.2s;
        }
        .h-row:hover { border-color: var(--primary); background: #FFF8E1; }
        
        .h-item { font-weight: 700; font-size: 1rem; flex: 1; color: var(--text-color); }
        
        .h-options { display: flex; gap: 5px; }
        .h-btn {
            padding: 6px 12px;
            border: 1px solid #BCAAA4;
            background: #F5F5F5;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            color: #5D4037;
            transition: all 0.2s;
        }
        .h-btn:hover { background: #D7CCC8; }
        .h-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .h-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .h-btn.wrong { background: var(--accent); color: white; border-color: var(--accent); opacity: 0.8; }


        /* --- SCORE FINAL TABLE --- */
        .final-score-container {
            margin: 30px 0;
            text-align: center;
        }
        .big-score-box {
            display: inline-block;
            background: white;
            border: 4px solid var(--gold);
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        .score-fraction { font-size: 3rem; font-weight: 900; color: var(--primary); line-height: 1; }
        .score-percent { font-size: 2rem; color: var(--success); font-weight: bold; margin-top: 5px; }
        
        .breakdown-table {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 1px solid #D7CCC8;
        }
        .breakdown-table th { background: var(--primary); color: #FFECB3; padding: 12px; font-family: 'Merriweather', serif; }
        .breakdown-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 1.1rem; }
        .breakdown-table td:last-child { text-align: right; font-weight: bold; color: var(--primary); }
        .breakdown-table tr:last-child td { border-bottom: none; }


        /* UTILS */
        .hidden { display: none !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }


        /* RESPONSIVE */
        @media (max-width: 768px) {
            .aspects-row { flex-direction: column; align-items: center; }
            .aspects-row::before { display: none; }
            .aspect-column::before { display: none; }
            .tree-connector-v { display: none; }
            .aspect-column { width: 100%; margin-top: 15px; }
            .h-row { flex-direction: column; gap: 10px; text-align: center; }
            .h-options { width: 100%; justify-content: center; }
            .h-btn { flex: 1; }
        }
    </style>
</head>
<body>


<header>
    <div class="logo">
        <i class="fas fa-compass"></i> Mission : Structure
    </div>
    <div class="header-info">
        <span class="badge" id="slide-indicator">1 / 10</span>
        <span class="badge"><i class="fas fa-gem"></i> <span id="score">0</span></span>
    </div>
</header>


<main id="app">
    <!-- Contenu injecté dynamiquement -->
</main>


<script>
    // --- DONNÉES DU JEU ---


    // JEU 1 : ASSOCIATION (Thèmes Archéo/Découverte)
    const associationsData = [
        {
            title: "Niveau 1 : Trésors Antiques",
            pairs: [
                { id: 1, text: "L'histoire des pyramides", type: "neutre", matchId: 101 },
                { id: 101, text: "Les géants de pierre du désert", type: "accrocheur", matchId: 1 },
                { id: 2, text: "La découverte de Pompéi", type: "neutre", matchId: 102 },
                { id: 102, text: "Une ville figée sous la cendre", type: "accrocheur", matchId: 2 },
                { id: 3, text: "Les outils préhistoriques", type: "neutre", matchId: 103 },
                { id: 103, text: "Survivre à l'âge de pierre", type: "accrocheur", matchId: 3 }
            ]
        },
        {
            title: "Niveau 2 : Explorateurs",
            pairs: [
                { id: 4, text: "Le voyage de Christophe Colomb", type: "neutre", matchId: 104 },
                { id: 104, text: "Vers l'inconnu : la traversée de l'Atlantique", type: "accrocheur", matchId: 4 },
                { id: 5, text: "L'équipement de plongée", type: "neutre", matchId: 105 },
                { id: 105, text: "Respirer sous les mers : un défi technique", type: "accrocheur", matchId: 5 },
                { id: 6, text: "La carte au trésor", type: "neutre", matchId: 106 },
                { id: 106, text: "X marque l'emplacement : mythe ou réalité ?", type: "accrocheur", matchId: 6 }
            ]
        },
        {
            title: "Niveau 3 : Mystères",
            pairs: [
                { id: 7, text: "L'écriture hiéroglyphique", type: "neutre", matchId: 107 },
                { id: 107, text: "Déchiffrer le langage des dieux", type: "accrocheur", matchId: 7 },
                { id: 8, text: "La momification égyptienne", type: "neutre", matchId: 108 },
                { id: 108, text: "Le voyage éternel : préserver le corps", type: "accrocheur", matchId: 8 },
                { id: 9, text: "Les statues de l'île de Pâques", type: "neutre", matchId: 109 },
                { id: 109, text: "Les gardiens silencieux du Pacifique", type: "accrocheur", matchId: 9 }
            ]
        }
    ];


    // JEU 2 : ARBRES (Textes plus complexes avec marqueurs de relation)
    const treesData = [
        {
            title: "Dossier 1 : Pétra, la cité rose",
            text: `
                <p>Cachée au cœur des montagnes jordaniennes, Pétra est l'un des sites archéologiques les plus célèbres au monde. Cette cité antique, taillée directement dans la roche gréseuse, fascine autant par sa beauté que par l'ingéniosité de ses bâtisseurs, les Nabatéens.</p>
                
                <p><span class='marker'>Tout d'abord</span>, Pétra se distingue par son architecture spectaculaire. Le monument le plus connu, le Khazneh (ou « Trésor »), présente une façade de 40 mètres de haut sculptée avec une précision incroyable. <span class='marker'>De plus</span>, la ville regorge de tombeaux royaux creusés dans les falaises, témoignant de l'importance du culte des morts. <span class='marker'>Enfin</span>, on y trouve un immense théâtre romain capable d'accueillir des milliers de spectateurs, preuve de l'influence culturelle de l'époque.</p>


                <p><span class='marker'>Par ailleurs</span>, la survie de cette cité en plein désert reposait sur une maîtrise exceptionnelle de l'eau. Les ingénieurs nabatéens ont construit un réseau complexe de canaux et de barrages pour récolter l'eau de pluie. <span class='marker'>Ensuite</span>, d'immenses citernes souterraines permettaient de stocker cette ressource précieuse pour les périodes de sécheresse, assurant ainsi la prospérité de la ville.</p>
            `,
            tree: {
                main: "Pétra / La cité antique",
                aspects: [
                    { title: "Architecture spectaculaire", subs: ["Le Khazneh (Trésor)", "Tombeaux royaux", "Théâtre romain"] },
                    { title: "Maîtrise de l'eau / Ingéniosité", subs: ["Canaux et barrages", "Citernes souterraines"] }
                ]
            }
        },
        {
            title: "Dossier 2 : Le Titanic",
            text: `
                <p>En 1912, le Titanic était le plus grand paquebot jamais construit. Pourtant, son voyage inaugural s'est transformé en tragédie. L'étude de son épave, découverte en 1985, nous permet de mieux comprendre les causes de cette catastrophe maritime.</p>


                <p><span class='marker'>En premier lieu</span>, des erreurs humaines et techniques expliquent le naufrage. Le navire naviguait trop vite dans une zone connue pour ses icebergs, ignorant les avertissements. <span class='marker'>De surcroît</span>, les rivets de la coque étaient de mauvaise qualité, ce qui a fragilisé le bateau lors du choc. <span class='marker'>Aussi</span>, le nombre de canots de sauvetage était largement insuffisant pour sauver tous les passagers.</p>


                <p><span class='marker'>En second lieu</span>, l'organisation sociale à bord reflétait les inégalités de l'époque. Les passagers de première classe profitaient d'un luxe inouï avec des suites somptueuses et des restaurants gastronomiques. <span class='marker'>À l'opposé</span>, les passagers de troisième classe, souvent des immigrants, voyageaient dans des conditions beaucoup plus modestes, entassés dans les ponts inférieurs.</p>
            `,
            tree: {
                main: "Le Naufrage du Titanic",
                aspects: [
                    { title: "Causes du naufrage", subs: ["Vitesse excessive", "Rivets fragiles", "Manque de canots"] },
                    { title: "Organisation sociale / Classes", subs: ["Luxe de la 1ère classe", "Pauvreté de la 3ème classe"] }
                ]
            }
        },
        {
            title: "Dossier 3 : Les Mayas",
            text: `
                <p>La civilisation maya, qui s'est épanouie en Amérique centrale, reste l'une des plus brillantes de l'histoire humaine. Avant leur mystérieux déclin, les Mayas ont excellé dans de nombreux domaines intellectuels et pratiques.</p>


                <p><span class='marker'>D'une part</span>, leurs connaissances astronomiques et mathématiques étaient très avancées. Ils ont élaboré un calendrier solaire d'une précision remarquable pour gérer les cycles agricoles. <span class='marker'>Également</span>, ils ont inventé le concept du zéro bien avant les Européens, ce qui facilitait leurs calculs complexes. <span class='marker'>En outre</span>, ils observaient le mouvement des planètes comme Vénus pour prédire l'avenir.</p>


                <p><span class='marker'>D'autre part</span>, l'architecture maya témoigne de leur puissance. Ils ont érigé des pyramides à degrés, souvent surmontées de temples pour leurs rituels religieux. <span class='marker'>De plus</span>, ils construisaient des terrains de jeu de balle, un sport sacré qui avait une grande importance politique et religieuse.</p>
            `,
            tree: {
                main: "La Civilisation Maya",
                aspects: [
                    { title: "Sciences (Astronomie/Maths)", subs: ["Calendrier solaire", "Concept du zéro", "Observation des planètes"] },
                    { title: "Architecture", subs: ["Pyramides à degrés", "Terrains de jeu de balle"] }
                ]
            }
        }
    ];


    // JEU 3 : HIERARCHIE (7 Éléments : 1 Sujet, 2 Aspects, 4 Sous-aspects)
    const hierarchyData = [
        {
            title: "Classement : L'Égypte Antique",
            items: [
                { text: "L'Égypte Antique", role: "sujet" },
                { text: "Les Dieux", role: "aspect" },
                { text: "Les Monuments", role: "aspect" },
                { text: "Râ (Soleil)", role: "sous-aspect" },
                { text: "La Grande Pyramide", role: "sous-aspect" },
                { text: "Anubis (Chacal)", role: "sous-aspect" },
                { text: "Le Sphinx", role: "sous-aspect" }
            ]
        },
        {
            title: "Classement : Les Volcans",
            items: [
                { text: "Les Volcans", role: "sujet" },
                { text: "Les types d'éruptions", role: "aspect" },
                { text: "Les produits volcaniques", role: "aspect" },
                { text: "Explosive", role: "sous-aspect" },
                { text: "La lave", role: "sous-aspect" },
                { text: "Effusive (Calme)", role: "sous-aspect" },
                { text: "Les cendres", role: "sous-aspect" }
            ]
        },
        {
            title: "Classement : Le Moyen Âge",
            items: [
                { text: "La Société Féodale", role: "sujet" },
                { text: "La Noblesse", role: "aspect" },
                { text: "Les Paysans", role: "aspect" },
                { text: "Le Roi", role: "sous-aspect" },
                { text: "Les Serfs", role: "sous-aspect" },
                { text: "Les Chevaliers", role: "sous-aspect" },
                { text: "Les Vilains (Libres)", role: "sous-aspect" }
            ]
        }
    ];


    // --- ÉTAT GLOBAL ---
    let currentState = {
        slideIndex: 0,
        score: 0,
        totalSlides: 0,
        scoresBySection: {
            assoc: 0,
            tree: 0,
            hierarchy: 0
        },
        maxScores: {
            assoc: 9, // 3 slides * 3 pairs * 1 pt
            tree: 15, // 3 slides * 5 pts
            hierarchy: 21 // 3 slides * 7 items * 1 pt
        }
    };


    // --- GÉNÉRATEUR DE SLIDES ---
    function generateSlides() {
        const app = document.getElementById('app');
        let html = '';
        let slideCount = 0;


        // Intro
        html += `
        <div class="slide active" id="slide-${slideCount}">
            <div class="card" style="text-align: center; padding-top:40px; background-image: radial-gradient(#FDF5E6 50%, #FFF8E1 100%);">
                <div style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"><i class="fas fa-map-marked-alt"></i></div>
                <h1 style="font-size: 2.2rem; color: var(--primary);">Mission : Structure</h1>
                <p style="font-size:1.2rem; margin-bottom: 30px;">Bienvenue, jeune archéologue !<br>Ta mission est de déterrer la structure cachée des textes descriptifs.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: left;">
                    <div style="background:white; padding:15px; border-left: 4px solid var(--primary); border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <strong><i class="fas fa-link"></i> 1. Associer</strong><br>
                        Relie les titres neutres à leurs équivalents accrocheurs.
                    </div>
                    <div style="background:white; padding:15px; border-left: 4px solid var(--accent); border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <strong><i class="fas fa-project-diagram"></i> 2. Reconstruire</strong><br>
                        Lis des dossiers complexes et reconstruis leur plan (Arbre).
                    </div>
                    <div style="background:white; padding:15px; border-left: 4px solid var(--success); border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <strong><i class="fas fa-layer-group"></i> 3. Classifier</strong><br>
                        Trie les éléments : Sujet, Aspect ou Sous-aspect.
                    </div>
                </div>
                <br><br>
                <button class="btn" onclick="nextSlide()">Commencer l'expédition <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>`;
        slideCount++;


        // 1. Association Slides
        associationsData.forEach((data, index) => {
            html += `
            <div class="slide" id="slide-${slideCount}">
                <div class="card">
                    <h4><i class="fas fa-scroll"></i> ${data.title}</h4>
                    <p>Associe le titre <strong>Neutre</strong> (scientifique) à son titre <strong>Accrocheur</strong> (journalistique).</p>
                    <div class="grid-match" id="match-grid-${index}">
                        ${data.pairs.map(p => `
                            <div class="match-card" onclick="handleMatchClick(this, ${index})" 
                                 data-id="${p.id}" data-match="${p.matchId}" data-type="${p.type}">
                                <div class="card-badge ${p.type === 'neutre' ? 'neutre' : 'accro'}">
                                    ${p.type === 'neutre' ? 'Neutre' : 'Accrocheur'}
                                </div>
                                <span class="card-text">${p.text}</span>
                            </div>
                        `).sort(() => Math.random() - 0.5).join('')}
                    </div>
                    <div id="feedback-match-${index}" style="min-height:20px; text-align:center; margin-top:20px; font-weight:bold; color:var(--success);"></div>
                    <div class="center-btn">
                        <button class="btn hidden" id="next-btn-match-${index}" onclick="nextSlide()">Dossier Suivant <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>`;
            slideCount++;
        });


        // 2. Tree Slides (Logic adapted for variable sub-aspects)
        treesData.forEach((data, index) => {
            html += `
            <div class="slide" id="slide-${slideCount}">
                <div class="card">
                    <h4><i class="fas fa-search"></i> Structure : ${data.title}</h4>
                    <p>Analyse le texte. Repère les connecteurs (<span style="color:var(--accent); font-weight:bold;">Mots en orange</span>) pour identifier l'ordre et l'addition.</p>
                    
                    <div class="text-reader">
                        ${data.text}
                    </div>


                    <div class="tree-wrapper">
                        <!-- Niveau 1 : Titre -->
                        <div class="tree-node-main">
                            <label class="label-tag">Sujet Divisé (Titre)</label>
                            <input type="text" class="input-box" id="tree-${index}-main" placeholder="Quel est le sujet principal ?">
                            <div class="correction" id="corr-tree-${index}-main">
                                <i class="fas fa-check"></i> ${data.tree.main}
                            </div>
                            <div class="tree-connector-v"></div>
                        </div>


                        <!-- Niveau 2 & 3 -->
                        <div class="aspects-row">
                            ${data.tree.aspects.map((asp, i) => `
                                <div class="aspect-column">
                                    <label class="label-tag" style="color:var(--primary); font-size: 0.9rem;">Aspect ${i+1}</label>
                                    <input type="text" class="input-box" id="tree-${index}-asp-${i}" placeholder="Idée principale du paragraphe...">
                                    <div class="correction" id="corr-tree-${index}-asp-${i}">
                                        <i class="fas fa-check"></i> ${asp.title}
                                    </div>
                                    
                                    <div style="margin-top:15px; border-top:2px dotted #BCAAA4; padding-top:10px;">
                                        <label class="label-tag" style="font-size:0.75rem; color:#8D6E63;">${asp.subs.length} Sous-aspects</label>
                                        ${asp.subs.map((sub, j) => `
                                            <input type="text" class="input-box" style="margin-bottom:8px; font-size:0.9rem;" id="tree-${index}-sub-${i}-${j}" placeholder="Détail ${j+1}...">
                                        `).join('')}
                                        
                                        <div class="correction" id="corr-tree-${index}-sub-${i}">
                                            ${asp.subs.map(s => `• ${s}`).join('<br>')}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>


                    <div class="center-btn">
                        <div id="tree-error-${index}" style="color:var(--accent); font-weight:bold; margin-bottom:10px; min-height:1.5em;"></div>
                        <button class="btn btn-secondary" id="check-tree-${index}" onclick="validateTree(${index})">
                            <i class="fas fa-search-location"></i> Vérifier mes hypothèses
                        </button>
                        <button class="btn hidden" id="next-tree-${index}" onclick="nextSlide()">Continuer <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>`;
            slideCount++;
        });


        // 3. Hierarchy Slides (7 items)
        hierarchyData.forEach((data, index) => {
            html += `
            <div class="slide" id="slide-${slideCount}">
                <div class="card">
                    <h4><i class="fas fa-sitemap"></i> ${data.title}</h4>
                    <p>Classe ces 7 éléments archéologiques dans la bonne catégorie.</p>
                    
                    <div class="hierarchy-game">
                        ${data.items.map((item, i) => `
                            <div class="h-row" id="h-row-${index}-${i}" data-role="${item.role}">
                                <div class="h-item">${item.text}</div>
                                <div class="h-options">
                                    <button class="h-btn" onclick="selectHierarchy(this, 'sujet', ${index})">Sujet</button>
                                    <button class="h-btn" onclick="selectHierarchy(this, 'aspect', ${index})">Aspect</button>
                                    <button class="h-btn" onclick="selectHierarchy(this, 'sous-aspect', ${index})">Sous-aspect</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>


                    <div class="center-btn">
                         <button class="btn hidden" id="next-h-${index}" onclick="nextSlide()">Mission Suivante <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>`;
            slideCount++;
        });


        // Final
        html += `
        <div class="slide" id="slide-${slideCount}">
            <div class="card" style="text-align: center; padding: 40px 20px; background-image: radial-gradient(#FDF5E6 50%, #FFF8E1 100%);">
                <h1 style="font-size: 2.5rem; margin-bottom: 10px; color: var(--primary);">Rapport de Mission</h1>
                <p style="font-size: 1.1rem; color: #5D4037; margin-bottom:20px;">Analyse complète de tes compétences d'archéologue textuel.</p>
                
                <div class="final-score-container">
                    <div class="big-score-box">
                        <div class="score-fraction" id="final-fraction">--/--</div>
                        <div class="score-percent" id="final-percent">--%</div>
                    </div>
                    
                    <h3 style="color:var(--primary); border-bottom:2px solid var(--gold); display:inline-block; padding-bottom:5px;">Détails par Compétence</h3>
                    <br><br>
                    
                    <table class="breakdown-table">
                        <tr>
                            <td><i class="fas fa-link" style="color:var(--primary);"></i> Association (Titres)</td>
                            <td id="score-assoc">--/--</td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-search" style="color:var(--accent);"></i> Reconstruction (Plan)</td>
                            <td id="score-tree">--/--</td>
                        </tr>
                        <tr>
                            <td><i class="fas fa-sitemap" style="color:var(--success);"></i> Classification (Hiérarchie)</td>
                            <td id="score-hierarchy">--/--</td>
                        </tr>
                    </table>


                    <p id="final-message" style="margin-top: 20px; font-style: italic; font-weight: bold; color: #5D4037;"></p>
                </div>
                
                <button class="btn btn-secondary" onclick="location.reload()"><i class="fas fa-redo"></i> Nouvelle Expédition</button>
            </div>
        </div>`;


        app.innerHTML = html;
        document.getElementById('slide-indicator').innerText = `1 / ${slideCount + 1}`;
        currentState.totalSlides = slideCount;
    }


    // --- NAVIGATION ---
    function nextSlide() {
        const current = document.getElementById(`slide-${currentState.slideIndex}`);
        current.classList.remove('active');
        
        currentState.slideIndex++;
        
        if (currentState.slideIndex <= currentState.totalSlides) {
            const next = document.getElementById(`slide-${currentState.slideIndex}`);
            if(next) {
                next.classList.add('active');
                document.getElementById('slide-indicator').innerText = `${currentState.slideIndex + 1} / ${currentState.totalSlides + 1}`;
                window.scrollTo(0,0);
            }
            
            // Si on arrive à la dernière slide, on calcule les résultats
            if (currentState.slideIndex === currentState.totalSlides) {
                displayFinalResults();
            }
        }
    }


    function addScore(points, section) {
        currentState.score += points;
        
        // Ajout au sous-total
        if(section && currentState.scoresBySection.hasOwnProperty(section)) {
            currentState.scoresBySection[section] += points;
        }


        const scoreEl = document.getElementById('score');
        scoreEl.innerText = currentState.score;
        scoreEl.style.transition = "transform 0.2s";
        scoreEl.style.transform = "scale(1.5)";
        setTimeout(() => scoreEl.style.transform = "scale(1)", 300);
    }


    function displayFinalResults() {
        const totalMax = currentState.maxScores.assoc + currentState.maxScores.tree + currentState.maxScores.hierarchy;
        const percent = Math.round((currentState.score / totalMax) * 100);


        // Affichage Fraction et %
        document.getElementById('final-fraction').innerText = `${currentState.score} / ${totalMax}`;
        document.getElementById('final-percent').innerText = `${percent}%`;


        // Affichage Tableau Détails
        document.getElementById('score-assoc').innerText = `${currentState.scoresBySection.assoc} / ${currentState.maxScores.assoc}`;
        document.getElementById('score-tree').innerText = `${currentState.scoresBySection.tree} / ${currentState.maxScores.tree}`;
        document.getElementById('score-hierarchy').innerText = `${currentState.scoresBySection.hierarchy} / ${currentState.maxScores.hierarchy}`;


        // Message personnalisé
        const msgEl = document.getElementById('final-message');
        if (percent >= 85) {
            msgEl.innerText = "Incroyable ! Tu es un véritable maître de la structure !";
            msgEl.style.color = "var(--success)";
        } else if (percent >= 70) {
            msgEl.innerText = "Très bon travail ! Quelques détails à peaufiner, mais tu as compris l'essentiel.";
            msgEl.style.color = "var(--primary)";
        } else {
            msgEl.innerText = "Bon début ! Regarde le tableau pour voir quelle section pratiquer davantage.";
            msgEl.style.color = "var(--accent)";
        }
    }


    // --- LOGIQUE JEU 1 (ASSOCIATION) ---
    let matchState = { selected: null, matches: 0 };


    function handleMatchClick(el, gridIndex) {
        if (el.classList.contains('matched') || el.classList.contains('selected')) return;


        el.classList.add('selected');


        if (!matchState.selected) {
            matchState.selected = el;
        } else {
            const card1 = matchState.selected;
            const card2 = el;
            
            if (parseInt(card1.dataset.match) === parseInt(card2.dataset.id)) {
                // Success
                card1.classList.remove('selected'); card1.classList.add('matched');
                card2.classList.remove('selected'); card2.classList.add('matched');
                
                card1.querySelector('.card-badge').style.display = 'block';
                card2.querySelector('.card-badge').style.display = 'block';


                matchState.matches++;
                addScore(1, 'assoc'); // Section Assoc
                
                if (matchState.matches === 3) {
                    document.getElementById(`next-btn-match-${gridIndex}`).classList.remove('hidden');
                    document.getElementById(`feedback-match-${gridIndex}`).innerText = "Artefacts identifiés !";
                    matchState.matches = 0;
                }
            } else {
                // Error
                card1.classList.add('error');
                card2.classList.add('error');
                setTimeout(() => {
                    card1.classList.remove('selected', 'error');
                    card2.classList.remove('selected', 'error');
                }, 600);
            }
            matchState.selected = null;
        }
    }


    // --- LOGIQUE JEU 2 (ARBRES - DYNAMIQUE & SÉCURISÉE) ---
    function validateTree(index) {
        const errorEl = document.getElementById(`tree-error-${index}`);
        const mainInput = document.getElementById(`tree-${index}-main`);
        
        // Reset error message
        if (errorEl) errorEl.innerText = "";


        // Check if main title is filled
        if (!mainInput || mainInput.value.trim().length < 2) {
            if (errorEl) {
                errorEl.innerText = "N'oublie pas d'écrire le titre principal du dossier !";
                // Animation de secousse
                mainInput.style.borderColor = "var(--accent)";
                setTimeout(() => mainInput.style.borderColor = "#BCAAA4", 1000);
            } else {
                // Fallback si le div erreur n'existe pas
                console.warn("Please fill the main title");
            }
            return;
        }


        try {
            // Reveal corrections
            const mainCorr = document.getElementById(`corr-tree-${index}-main`);
            if(mainCorr) mainCorr.classList.add('show');
            
            const currentTreeData = treesData[index].tree;
            currentTreeData.aspects.forEach((asp, i) => {
                const aspEl = document.getElementById(`corr-tree-${index}-asp-${i}`);
                const subEl = document.getElementById(`corr-tree-${index}-sub-${i}`);
                if(aspEl) aspEl.classList.add('show');
                if(subEl) subEl.classList.add('show');
            });


            const checkBtn = document.getElementById(`check-tree-${index}`);
            const nextBtn = document.getElementById(`next-tree-${index}`);
            
            if(checkBtn) checkBtn.classList.add('hidden');
            if(nextBtn) nextBtn.classList.remove('hidden');


            addScore(5, 'tree'); // Section Tree
        } catch (e) {
            console.error("Erreur validation arbre:", e);
            // Fallback d'urgence pour ne pas bloquer l'élève
            if (errorEl) errorEl.innerText = "Erreur technique, mais bravo ! Passe à la suite.";
            const nextBtn = document.getElementById(`next-tree-${index}`);
            if(nextBtn) nextBtn.classList.remove('hidden');
        }
    }


    // --- LOGIQUE JEU 3 (HIERARCHIE - 7 Items) ---
    function selectHierarchy(btn, role, gameIndex) {
        const row = btn.closest('.h-row');
        const correctRole = row.dataset.role;
        
        const buttons = row.querySelectorAll('.h-btn');
        buttons.forEach(b => b.classList.remove('active', 'correct', 'wrong'));
        
        btn.classList.add('active');


        if (role === correctRole) {
            btn.classList.add('correct');
            buttons.forEach(b => b.disabled = true);
            row.dataset.solved = "true";
            addScore(1, 'hierarchy'); // Section Hierarchy
            checkHierarchyComplete(gameIndex);
        } else {
            btn.classList.add('wrong');
        }
    }


    function checkHierarchyComplete(index) {
        const rows = document.querySelectorAll(`#slide-${currentState.slideIndex} .h-row`);
        const allSolved = Array.from(rows).every(r => r.dataset.solved === "true");
        
        if (allSolved) {
            document.getElementById(`next-h-${index}`).classList.remove('hidden');
        }
    }


    // Init
    generateSlides();


</script>


</body>
</html>